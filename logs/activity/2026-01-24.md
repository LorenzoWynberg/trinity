# Activity Log - 2026-01-24

## STORY-1.1.2: Create CLI entrypoint with Cobra

### What was done
- Modified `cli/cmd/trinity/main.go` to use spf13/cobra framework
- Created root command with descriptive help text
- Added github.com/spf13/cobra v1.10.2 as a direct dependency
- Connected version output to core.Version constant
- Verified `go work sync` succeeds
- Verified `go build ./cli/cmd/trinity` produces binary
- Verified `./trinity --help` shows usage with getting started guide
- Verified `./trinity --version` shows version 0.1.0

### Files modified
- `cli/cmd/trinity/main.go` - Cobra-based CLI entrypoint
- `cli/go.mod` - Added spf13/cobra dependency

### Acceptance criteria met
- [x] cli/cmd/trinity/main.go exists
- [x] Uses github.com/spf13/cobra for CLI
- [x] Root command with basic help text
- [x] go build ./cli/cmd/trinity produces binary
- [x] ./trinity --help shows usage

### Learnings
- Cobra's Version field on the root command auto-generates --version flag
- Long description in Cobra supports multi-line strings for better help text formatting

---

## Ralph Plan Implementation (Phase 1)

### Editor-Based Feedback Input
- Updated `get-feedback` in `lib/pr.elv` to use editor
- Opens `$EDITOR` / `$VISUAL` / vim with temp file
- Comment lines (starting with #) are ignored
- Empty file cancels feedback

### Story Validation
- Added `validate-story` function in `lib/claude.elv`
- Claude checks if acceptance criteria are clear
- Returns `<valid/>` or `<needs-clarification>` with questions
- Added `--no-validate` flag to skip validation
- Integrated into ralph.elv before Claude execution

### YOLO Mode
- Added `--yolo` flag to `lib/cli.elv`
- Sets: no-validate + auto-pr + auto-merge
- Added warning message on activation

### PR Comment-Based Feedback System
- Added `pr_url` field to `state.json` schema
- Created `post-feedback-comment` function - posts feedback as PR comment
- Created `post-resolution-comment` function - posts changes applied
- Created `get-all-pr-comments` function - reads all comments
- Updated `run-flow` to accept and return `pr_url` state
- PR prompt skipped when `pr_url` already exists in state
- PR description now only updated at merge time (saves tokens)
- Feedback posted as PR comments (visible on GitHub, free)

### Automatic Learning Extraction
- Created `extract-learnings` function in `lib/claude.elv`
- Reads activity log and diff for context
- Asks Claude to identify gotchas, patterns, conventions
- Parses `<learning file="X">` blocks and appends to docs/learnings/
- Created initial learnings structure: gotchas.md, patterns.md, conventions.md
- Integrated into ralph.elv after `<story-complete>`, before PR flow

### Files modified
- `tools/ralph/cli/lib/pr.elv` - Editor feedback, PR comment functions, run-flow changes
- `tools/ralph/cli/lib/claude.elv` - Story validation, learning extraction functions
- `tools/ralph/cli/lib/cli.elv` - --no-validate and --yolo flags
- `tools/ralph/cli/lib/state.elv` - Added pr_url field
- `tools/ralph/cli/ralph.elv` - Validation integration, pr_url handling, learning extraction
- `docs/learnings/gotchas.md` - Created
- `docs/learnings/patterns.md` - Created
- `docs/learnings/conventions.md` - Created

### Desktop Notifications
- Created `notify` function in `lib/ui.elv`
- macOS support via `osascript`
- Linux support via `notify-send`
- Added `--notify` flag
- Triggers on story complete, blocked, all complete

### Skip Story Command
- Added `--skip STORY-ID "reason"` flag
- Created `skip-story` function in `lib/prd.elv`
- Sets skipped=true, passes=true, merged=true (unblocks dependents)
- Logs skip to activity file
- Updated help text

### Configurable Timeouts
- Added `--timeout <seconds>` flag
- Defaults to 1800s (30 min)
- Passed through to Claude invocation

### Auto-archive Activity Logs
- Created `archive-old-logs` function in lib/claude.elv
- Archives logs older than 7 days to logs/activity/archive/YYYY-MM/
- Runs on startup before main loop
- Works on both macOS and Linux

### Retry Clean Slate
- Added `--retry-clean STORY-ID` flag
- Deletes local and remote branch
- Resets story in prd.json (passes=false, merged=false)
- Clears state.json

### Pre-flight Checks
- Created `preflight-checks` function
- Checks: clean git state, GitHub auth, required tools, base branch sync
- Prompts to continue if issues found
- Runs on startup

### Verbose Mode
- Added `--verbose` / `-v` flag to `lib/cli.elv`
- Shows full prompts being sent to Claude
- Shows raw Claude output after execution
- Shows state transitions (in_progress, idle, blocked, feedback loop)
- Updated help text in `lib/ui.elv`

### Status Command
- Added `--status` flag to `lib/cli.elv`
- Created `show-status` function in `lib/prd.elv`
- Displays phase/epic/story hierarchy with progress
- Shows progress percentage (merged/total)
- Shows current story and branch if work in progress
- Legend: [x] merged, [*] passed, [~] skipped, [ ] pending

### Claude Commit Messages
- Created `generate-commit-message` function in `lib/claude.elv`
- Takes story-id and branch-name, returns conventional commit message
- Uses Claude to analyze diff and generate appropriate type/scope/description
- Updated `prompt.md` with detailed conventional commit format instructions
- Includes type (feat/fix/refactor/etc), scope, description, and bullet points

### Plan Mode
- Added `--plan` flag to `lib/cli.elv`
- Created `prepare-plan-prompt` function in `lib/claude.elv`
- Plan prompt includes story details, acceptance criteria, dependencies
- Runs Claude without `--dangerously-skip-permissions` (read-only)
- Outputs implementation plan to stdout without making changes
- Integrated into ralph.elv with early exit after plan generation

### Metrics Tracking
- Created `lib/metrics.elv` module with init, record, show-stats, extract-tokens functions
- Created `metrics.json` structure (totals + per-story breakdown)
- Token extraction from Claude stream-json output
- Records duration, input/output tokens on story complete
- Added `--stats` flag to show metrics summary
- Stats display shows total tokens, duration, averages, recent stories

---

## Ralph Dashboard

### Project Setup
- Created `tools/dashboard/` with Next.js 14 (TypeScript, Tailwind, App Router)
- Initialized shadcn/ui with default config
- Added components: button, card, badge, tabs, table, separator, skeleton
- Lucide icons included

### Data Layer & Layout
- Created `lib/types.ts` with PRD, State, Metrics types
- Created `lib/data.ts` with data fetching functions (getPRD, getState, getMetrics, etc.)
- Built sidebar component with navigation links
- Updated root layout with sidebar + main content area

### Dashboard Home Page
- Created stats cards component (StatsCard)
- Created progress bar component (ProgressBar)
- Created current work component (CurrentWork)
- Built dashboard page with:
  - Stats row (total, merged, tokens, time)
  - Phase progress bars
  - Current work display
- Added 5-second revalidation for auto-refresh

### Stories Pages
- Created StoryCard component with status badges
- Built stories list page with tabs for filtering by status
- Stories grouped by phase within each tab
- Created story detail page with:
  - Header with ID, title, status
  - Intent and acceptance criteria
  - Dependencies and dependents (blocks) sections
  - Metadata (skip reason, merge commit)

### Remaining Pages
- Built metrics page with summary stats and story metrics table
- Built activity page with date tabs showing log content
- Built learnings page with category tabs (gotchas, patterns, conventions)
- All pages have 5-second revalidation for auto-refresh

### ANSI Code Fixes
- Fixed ANSI escape codes leaking into prd.json merge_commit field
- Fixed ANSI codes appearing in PR descriptions
- Root cause: `ui:*` functions output to stdout before redirect
- Solution: Use direct `echo "..." > /dev/tty` in functions that return values via `put`
- Cleaned up merge_commit for STORY-1.1.1

### PR URL Tracking
- Added `pr_url` field to Story interface in types.ts
- Created `set-pr-url` function in `lib/prd.elv`
- Updated `pr.elv` create function to save PR URL to prd.json
- Updated story detail page to display PR link with external link icon
- Added STORY-1.1.1 PR URL: https://github.com/trinity-ai-labs/trinity/pull/16

### Ralph Reorganization
- Moved `scripts/ralph/` to `tools/ralph/cli/`
- Moved `tools/dashboard/` to `tools/ralph/dashboard/`
- Updated all path references across docs and code
- New structure: `tools/ralph/{cli,dashboard}`

### Dependency Graph View
- Added `/graph` page with interactive dependency visualization
- Installed @xyflow/react for graph rendering
- Created StoryNode component with status-colored nodes
- Created useGraphData hook for client-side data fetching
- Added API routes: `/api/prd`, `/api/state`
- Features: click nodes to navigate, minimap, zoom/pan, animated edges for in-progress stories
- Added Graph link to sidebar navigation

### Graph Interaction Improvements
- Separated node click (highlight path) from info icon click (open modal)
- Created StoryModal component for viewing story details
- Added dependency path highlighting in yellow
- Highlighted nodes/edges have higher z-index
- Non-highlighted elements fade out, edges hidden completely

### Dark/Light Theme Support
- Installed next-themes for theme management
- Created ThemeProvider component
- Added settings page at `/settings` with theme toggle
- Theme persists to `settings.json` via `/api/settings`
- Updated StoryNode with theme-aware colors
- Updated graph background, controls, minimap for both themes
- Added CSS overrides for React Flow controls

### Graph Direction Setting
- Added graphDirection setting (horizontal/vertical)
- Updated settings page with direction toggle
- Graph layout adapts: horizontal = left-to-right, vertical = top-to-bottom
- Node handles change position based on direction

### Graph Direction Toggle on Graph Page
- Moved direction toggle from settings page to graph page
- Toggle button in top-right corner with arrow icon
- Clicking toggles between horizontal/vertical layout
- Saves preference to settings.json
- useGraphData hook now accepts direction as parameter

### Vertical Mode Improvements
- Centered rows in vertical mode
- Limited to 6 nodes per row, wraps to additional rows when needed
- Increased spacing between rows (V_GAP: 70) and columns (H_GAP: 80)
- Centered text in node boxes for vertical mode
- Double-click node to open modal (removed info icon)
- Click highlighted node again to deselect
- Added key={direction} to ReactFlow for proper re-centering on toggle

### Stories Page Filters
- Added phase dropdown filter at the top of stories page
- Added epic dropdown filter under each phase header
- Created StoriesList client component for interactive filtering
- Installed shadcn select component
- Filters work together with status tabs

### Graph Auto-Center
- Graph now always centers and fits completely on screen
- Uses ReactFlowProvider and useReactFlow for programmatic fitView
- Re-centers on direction toggle
- Only changes view when user zooms or interacts

### Dashboard Stories Added to Trinity PRD
Added 15 stories for Phase 8: Dashboard (v0.1):

- Epic 1: Dashboard Server (5 stories)
  - Server package, REST API, frontend scaffold, embed, CLI command
- Epic 2: Dashboard UI (7 stories)
  - Home page, stories list, dependency graph, activity, metrics, learnings, themes
- Epic 3: Real-time Features (3 stories)
  - WebSocket server, live Claude output, notifications

### Expanded v0.1 Documentation in ROADMAP.md
- Added full tech stack table: Go/Cobra, SQLite, Next.js 14, Tailwind, shadcn/ui, @xyflow/react, next-themes
- Documented CLI commands and core loop (9 steps)
- Documented dashboard architecture (embedded in Go binary, single port)
- Listed all dashboard pages with features
- Updated decisions table with all tech choices (Cobra, Tailwind, shadcn/ui, @xyflow/react)
- Updated PRD story acceptance criteria with specific tech requirements

### Reorganized Version Numbers
Expanded to five versions with clear progression:
- v1.0 - CLI Core (CLI + Auth)
- v2.0 - Local Dashboard (full control)
- v3.0 - Teams & Cloud (Team DB + Hosted Dashboard read-only)
- v4.0 - Cross-project dependencies
- v5.0 - Wails Desktop GUI

Removed Phase 8 (Dashboard) stories from PRD - those are v2.0, not v1.0.

Total v1.0 stories: 83

### Version Support Added
Added target_version field to stories for release tracking:

**Schema updates (CLAUDE.md):**
- Added target_version field to stories table
- Added versions table for release metadata
- Added version-related DB API methods
- Added version CLI commands

**PRD updates:**
- Added 3 new stories for version support (Epic 1.3)
- Tagged all 86 stories with target_version: "v1.0"

**Ralph updates (lib/prd.elv, lib/cli.elv, ralph.elv, lib/ui.elv):**
- Added get-versions, get-next-story-for-version, version-complete functions
- Added get-version-progress, show-version-status functions
- Added --version-status flag to show version progress
- Added --target-version flag to filter story execution by version
- Updated help text with new flags

Total stories: 86

### Multi-Version PRD Structure
Restructured Ralph to support multiple PRD files per version:

**New structure:**
- `prd/v1.0.json` - v1.0 stories
- `prd/v2.0.json` - v2.0 stories (when ready)

**Ralph changes:**
- Auto-selects lowest incomplete version by default
- `--target-version v1.0` to explicitly target a version
- `--version-status` shows progress for all version files
- Banner shows active version and PRD file
- Allows parallel work (Ralph on v1, human on v2)
- Activity logs now include version (e.g., "## v1.0 - STORY-1.2.3: Title")
- Prompt template updated with {{VERSION}} placeholder
- Plan mode includes version context

**Cross-version dependency syntax:**
```
STORY-1.1.1        -> specific story in current version
1                  -> whole phase 1 in current version
1:2                -> phase 1, epic 2 in current version
v1.0:STORY-1.1.1   -> specific story in v1.0
v1.0:1             -> whole phase 1 in v1.0
v1.0:1:2           -> phase 1, epic 2 in v1.0
v1.0               -> entire v1.0 must be complete
```

---

## Dashboard Improvements (continued)

### Markdown Renderer
- Installed react-markdown and remark-gfm
- Created `components/markdown.tsx` with custom styling for all elements
- Applied to activity and learnings pages
- Fixed code block double-styling (pre handles container, code is minimal inside)

### Graph Page Enhancements
- Added 4 layout options: Horizontal, Horizontal Compact, Vertical, Vertical Compact
- Compact layouts limit to 6 nodes per column/row
- Added TanStack Pacer for debounced layout saves (500ms)
- Added default layout per version (star button to set default)
- Fixed polling race condition using refs to preserve layout state
- Version nodes styled in purple with dark/light mode support
- Nodes locked in auto layouts, draggable only in custom layouts
- Added fullscreen toggle button (uses browser Fullscreen API)
- Fit-to-view available via React Flow controls panel

### Activity Logs Relocation
- Moved activity logs from `docs/activity/` to `logs/activity/`
- Updated all references in Ralph CLI scripts (ralph.elv, lib/claude.elv)
- Updated prompt.md templates
- Updated dashboard data layer
- Updated documentation (learnings, plans, README)

### Archived Logs Support in Dashboard
- Updated getActivityLogs to scan archive/YYYY-MM/ subdirectories
- Added `archived` flag to log entries
- Activity page now has Recent/Archived tabs
- Archived logs show badge indicator
- Counts displayed in header and tab labels
