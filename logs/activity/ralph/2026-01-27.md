# Ralph Activity Log - 2026-01-27

## Knowledge Base: PRD Structure Documentation

**Time:** 2026-01-27 ~11:00 CR

### What was done

Added comprehensive PRD structure documentation to the Ralph knowledge base. The existing docs covered CLI usage, workflows, and FAQ well, but lacked documentation explaining how the actual PRD files are structured.

**New documentation covers:**
- File organization (versioned JSON files: v0.1.json, v1.0.json, v2.0.json)
- Top-level structure (title, shortTitle, description, phases, epics, stories)
- Phase and epic definitions (separate arrays, not nested)
- Complete story schema with required and optional fields
- Story ID format (`1.2.3` numeric vs Trinity's planned `STORY-1.2.3`)
- Dependency syntax (same-version, cross-version, phase/epic/story refs)
- Two-stage completion (`passes` vs `merged` explained in detail)
- Human testing gates workflow
- External dependencies (`external_deps` and `external_deps_report`)
- State.json schema for runtime state tracking
- Complete story example showing all fields

### Files created

- `docs/knowledge/ralph/prd-structure.md` - PRD file structure documentation

### Files modified

- `docs/knowledge/ralph/index.json` - Added prd-structure page to navigation

---

## Knowledge Base: Documentation Audit & Improvements

**Time:** 2026-01-27 ~12:00 CR

### What was done

Audited Ralph implementation against documentation to identify gaps and inaccuracies. Found several undocumented features and missing flags, then updated docs to match actual code.

**CLI Reference updates:**
- Added missing `--refine-prd [ID]` flag with examples
- Added missing `--add-stories "desc"` flag with examples
- Improved descriptions for all flags to match help text in ui.elv
- Added "PRD Management Flags" section

**PRD Structure updates:**
- Clarified story ID format - both `1.2.3` and `STORY-1.2.3` work (normalized internally)
- Added missing `version` field to state schema
- Added missing `checkpoints` field to state schema

**New Advanced Features documentation:**
- Reverse dependency management (`--auto-add-reverse-deps`)
- Learning extraction and gotchas system (30-day compaction)
- Release workflow with hotfix loop
- Duplicate detection (expands on FAQ)
- Story validation and clarification
- Related story updates

### Files created

- `docs/knowledge/ralph/story-validation.md` - Story validation and clarification
- `docs/knowledge/ralph/duplicate-detection.md` - Duplicate detection workflow
- `docs/knowledge/ralph/reverse-dependencies.md` - Reverse dependency management
- `docs/knowledge/ralph/learning-extraction.md` - Learning extraction and gotchas compaction
- `docs/knowledge/ralph/release-workflow.md` - Release workflow with hotfix loop

### Files modified

- `docs/knowledge/ralph/cli-reference.md` - Added missing flags, improved descriptions
- `docs/knowledge/ralph/prd-structure.md` - Clarified story IDs, added state fields
- `docs/knowledge/ralph/index.json` - Added all new pages to navigation

---

## Knowledge Base: Dashboard Documentation Update

**Time:** 2026-01-27 ~13:00 CR

### What was done

Audited dashboard documentation against actual implementation. Found 95% alignment with some undocumented features. Updated docs to match current state.

**Additions:**
- Story Detail Page (`/stories/[id]`) - full story view with deps, PR tracking
- Settings Page - theme selection, default version
- System theme option (follows OS preference)
- Graph features: custom layouts, depth-based edge colors, dead-end toggle, external deps toggle, minimap
- Graph Layouts section - custom saved layouts per version

**Fixes:**
- Corrected npm scripts (`dev:local` → `dev:terminal`, added `dev:next`)

### Files modified

- `docs/knowledge/ralph/dashboard.md` - Added missing features, fixed scripts

---

## Knowledge Base: Reorganize Ralph into CLI and Dashboard Books

**Time:** 2026-01-27 ~14:00 CR

### What was done

Split the single "Ralph" book into two separate books for better organization:

**Ralph CLI** (`docs/knowledge/ralph-cli/`) - 10 pages:
- Overview, CLI Reference, Workflows, PRD Structure
- Story Validation, Duplicate Detection, Reverse Dependencies
- Learning Extraction, Release Workflow, FAQ

**Ralph Dashboard** (`docs/knowledge/ralph-dashboard/`) - 5 pages:
- Overview (pages summary)
- Graph (visualization, layouts, toggles)
- Terminal (PTY, tmux, ngrok)
- PRD Tools (wizard modals)
- Themes (cyber themes, mobile responsiveness)

### Files created

- `docs/knowledge/ralph-cli/index.json`
- `docs/knowledge/ralph-dashboard/index.json`
- `docs/knowledge/ralph-dashboard/index.md`
- `docs/knowledge/ralph-dashboard/graph.md`
- `docs/knowledge/ralph-dashboard/terminal.md`
- `docs/knowledge/ralph-dashboard/prd-tools.md`
- `docs/knowledge/ralph-dashboard/themes.md`

### Files moved

- All CLI docs moved from `ralph/` to `ralph-cli/`

### Files deleted

- `docs/knowledge/ralph/` (entire directory)

---

## Knowledge Base: Add Missing Dashboard Chapters

**Time:** 2026-01-27 ~14:30 CR

### What was done

Added missing chapter pages for each dashboard page:
- Stories (with story detail, blocked indicators)
- Metrics (token usage, cost tracking, story breakdown)
- Activity (daily logs, project filtering)
- Knowledge & Gotchas (book/chapter structure, navigation)
- Settings (theme, default version, persistence)

Updated index.md to be a cleaner overview with links to chapters.

### Files created

- `docs/knowledge/ralph-dashboard/stories.md`
- `docs/knowledge/ralph-dashboard/metrics.md`
- `docs/knowledge/ralph-dashboard/activity.md`
- `docs/knowledge/ralph-dashboard/knowledge-gotchas.md`
- `docs/knowledge/ralph-dashboard/settings.md`

### Files modified

- `docs/knowledge/ralph-dashboard/index.json` - Added new pages
- `docs/knowledge/ralph-dashboard/index.md` - Simplified to overview with links

---

## Gotchas: Reorganize Dashboard into Next.js and Node

**Time:** 2026-01-27 ~15:00 CR

### What was done

Split the "dashboard" gotchas book into two more specific books:

**nextjs/** - React/Next.js gotchas:
- Hydration issues
- iOS fullscreen fallback
- shadcn CLI usage
- Mobile hamburger menu

**node/** - Node.js native module gotchas:
- node-pty build issues

### Files created

- `docs/gotchas/node/index.json`
- `docs/gotchas/node/index.md`

### Files renamed/modified

- `docs/gotchas/dashboard/` → `docs/gotchas/nextjs/`
- `docs/gotchas/nextjs/index.json` - Updated title and description
- `docs/gotchas/nextjs/index.md` - Removed node-pty section, updated title

---

## Checkpoint System for Resume Functionality

**Time:** 2026-01-27 ~16:00 CR

### What was done

Implemented a checkpoint system for Ralph CLI that tracks progress at each major phase. When Ralph crashes or times out during Claude execution, the `--resume` flag now knows which phase to skip to instead of restarting from scratch.

**Checkpoint stages:**
- `branch_created` - Story selected, branch ready
- `validation_complete` - Story validated, deps checked
- `claude_started` - Claude invoked (can't resume mid-Claude)
- `claude_complete` - Signal detected, ready for PR
- `pr_created` - PR exists, waiting for merge

**State functions added to state.elv:**
- `save-checkpoint` - Save checkpoint with story ID, stage, timestamp, attempt, and stage-specific data
- `get-checkpoint` - Retrieve a specific checkpoint
- `has-checkpoint` - Check if a checkpoint exists
- `clear-checkpoints` - Remove all checkpoints for a story

**Resume logic in ralph.elv:**
- When `--resume` is passed, checks for existing checkpoints
- Skips to the appropriate phase based on most advanced checkpoint
- `pr_created` or `claude_complete` → skip to PR flow
- `validation_complete` → skip to Claude execution
- `branch_created` → skip to validation

**Checkpoint data stored:**
- `branch_created`: branch name, current commit
- `validation_complete`: clarification text (if any)
- `claude_started`: attempt number
- `claude_complete`: signal type, commit hash
- `pr_created`: PR URL

**Checkpoint cleanup:**
- Cleared when story completes (merged)
- Cleared when story is blocked
- Cleared during `--retry-clean`

**Bug fix - Elvish pipeline pattern:**
- Fixed `slurp | str:trim-space` pattern (causes arity mismatch)
- Correct pattern: `str:trim-space (... | slurp)` (nested, not piped)
- Fixed in ralph.elv and claude.elv

### Files modified

- `tools/ralph/cli/lib/state.elv` - Added checkpoint functions (save, get, has, clear)
- `tools/ralph/cli/ralph.elv` - Added checkpoint saves at 5 phases, resume logic, checkpoint clears
- `tools/ralph/cli/lib/claude.elv` - Fixed slurp|str:trim-space pattern

---

## Checkpoint Documentation & Elvish Gotcha

**Time:** 2026-01-27 ~17:00 CR

### What was done

Added comprehensive documentation for the checkpoint/recovery system and documented the Elvish pipeline gotcha discovered during implementation.

**New chapter - Recovery & Resume:**
- Checkpoint stages and data structures
- Resume modes (basic, fresh start, retry-clean)
- Common recovery scenarios (timeout, Ctrl+C, crash, stuck story)
- Debugging tips

**Elvish gotcha documented:**
- `slurp | str:trim-space` doesn't work (arity mismatch)
- Must use `str:trim-space (... | slurp)` instead
- This was a latent bug in claude.elv (caught by try/catch)

### Files created

- `docs/knowledge/ralph-cli/recovery.md` - Recovery & Resume chapter

### Files modified

- `docs/knowledge/ralph-cli/index.json` - Added recovery page to navigation
- `docs/knowledge/ralph-cli/cli-reference.md` - Simplified checkpoints section, links to recovery chapter
- `docs/knowledge/ralph-cli/faq.md` - Updated resume answer
- `docs/knowledge/ralph-cli/prd-structure.md` - Added checkpoint structure to state.json schema
- `docs/gotchas/elvish/index.md` - Added slurp|str:trim-space gotcha

---

## Validation Timing Fix

**Time:** 2026-01-27 ~18:00 CR

### What was done

Moved story validation and external deps checks BEFORE branch creation for new stories. Previously, if a user skipped during validation, the branch had already been created (wasted).

**Before:**
1. Select story
2. Create branch ← wasted if user skips
3. Validate story
4. If skip → branch was created for nothing

**After:**
1. Select story
2. Validate story
3. Check external deps
4. If skip at any point → no branch created
5. Create branch only when proceeding

**Implementation details:**
- Added `validation-done` flag to track if validation already done this iteration
- New stories: validation + ext deps before branch creation
- Resume/continue: old validation block still runs (for cases without checkpoints)
- Checkpoint saves adjusted: `validation_complete` saved after branch for new stories

### Files modified

- `tools/ralph/cli/ralph.elv` - Restructured validation timing, added validation-done flag

---

## Smarter Retry with Failure Context

**Time:** 2026-01-27 ~19:00 CR

### What was done

Implemented smart retry functionality that tracks failure reasons and injects context into retry prompts. After 2 failures with the same error, automatically prompts user for feedback instead of blindly retrying.

**State tracking added:**
- `last_error` - The error message from the most recent failure
- `failure_count` - Number of consecutive failures with the same error

**New state functions in state.elv:**
- `record-failure` - Track a failure, increment count if same error, reset if different
- `clear-failure` - Clear failure tracking (on success or story change)
- `get-failure-info` - Get current error and count

**Failure tracking points:**
- Claude timeout → "Timeout after Xs - story may be too complex"
- Claude error → "Claude error: <reason>"
- Story blocked signal → "Story blocked - Claude output <story-blocked> signal"

**Retry behavior:**
- Attempt 2+: Check for previous failure, inject context into prompt
- Attempt 3+ (same error): Auto-escalate to user with options:
  - `[f]eedback` - Open editor to provide guidance
  - `[r]etry` - Try again with failure context
  - `[s]kip` - Skip story for now

**Prompt injection:**
- New optional `&previous_failure` parameter in claude:prepare
- Adds "Previous Attempt Failed" section to prompt with:
  - The specific error message
  - Instructions to analyze and avoid the issue
  - Suggestion to try different approaches

**Cleanup:**
- Failure tracking cleared on story success
- Failure tracking cleared during --retry-clean
- pending-failure-context cleared after use in prompt

### Files modified

- `tools/ralph/cli/lib/state.elv` - Added last_error/failure_count fields, record-failure/clear-failure/get-failure-info functions
- `tools/ralph/cli/lib/claude.elv` - Added &previous_failure parameter, prompt injection for retry context
- `tools/ralph/cli/ralph.elv` - Failure tracking at 3 points, smart retry logic before Claude execution, cleanup on success

---

## Structured Signal File

**Time:** 2026-01-27 ~20:00 CR

### What was done

Replaced XML tag signals with a structured JSON signal file. Claude now writes `signal.json` instead of outputting XML tags in text, and Ralph reads that file for more reliable signal detection.

**Signal file schema:**
```json
{
  "status": "complete" | "blocked" | "all_complete",
  "story_id": "1.2.3",
  "files_changed": ["list", "of", "files"],
  "tests_passed": true | false,
  "message": "Reason if blocked"
}
```

**Benefits:**
- More reliable than regex parsing text output
- Richer metadata (files changed, tests passed, blocked reason)
- Easier to extend in future
- JSON parsing is deterministic

**Backwards compatibility:**
- Kept XML tag fallback in check-signals for older prompts
- Falls back to grep if signal.json doesn't exist

**Cleanup:**
- signal.json deleted after reading (in cleanup function)
- Added to .gitignore

### Files modified

- `tools/ralph/cli/instructions/completion.md` - Replaced XML tags with signal.json writing
- `tools/ralph/cli/prompts/feedback.md` - Updated all_complete reference
- `tools/ralph/cli/prompts/partials/workflow.md` - Replaced XML tags with signal.json
- `tools/ralph/cli/prompt.md` - Updated Quick Reference to show signal file
- `tools/ralph/cli/lib/claude.elv` - check-signals reads JSON first, XML fallback; cleanup deletes signal.json
- `tools/ralph/cli/ralph.elv` - Updated debug output messages
- `tools/ralph/cli/README.md` - Updated signal documentation
- `tools/ralph/cli/.gitignore` - Added signal.json

---

## Feedback Loop Micro-Learning Extraction

**Time:** 2026-01-27 ~21:00 CR

### What was done

Added automatic extraction of "fix patterns" from feedback loops. When user provides feedback and Claude fixes it successfully, the pattern (what was wrong → what fixed it) is extracted as a gotcha.

**Why this matters:**
- Feedback loops capture real mistakes and their solutions
- These "fix patterns" are often the most valuable gotchas
- Previously, only complete/blocked stories had learnings extracted

**New function in gotchas.elv:**
- `extract-feedback-learning` - Takes feedback text, gets diff of fix, asks Claude to extract reusable pattern

**Extraction prompt asks for:**
- Symptom (what user complained about)
- Cause (why it happened)
- Fix (how to avoid or fix it)

**Tracking in ralph.elv:**
- Added `last-used-feedback` variable to track feedback text
- Saved before clearing `pending-feedback`
- Called `extract-feedback-learning` after story completion when `was-feedback-refinement` is true

**Output format:**
- Gotcha is tagged with `<!-- From feedback loop on STORY-X.Y.Z -->` for traceability
- Only extracts if pattern is reusable (not too story-specific)

### Files modified

- `tools/ralph/cli/lib/gotchas.elv` - Added extract-feedback-learning function
- `tools/ralph/cli/ralph.elv` - Track last-used-feedback, call extraction after feedback success

---

## Activity Log YAML Frontmatter

**Time:** 2026-01-27 ~11:00 CR

### What was done

Added YAML frontmatter to activity log templates for machine-readable metadata. This enables the dashboard to query and aggregate activity data programmatically.

**Frontmatter fields:**
- `story_id` - Story being worked on
- `title` - Human-readable title
- `status` - complete/in_progress/blocked
- `started`/`completed` - Timestamps in CR timezone
- `duration_minutes` - Estimated time spent
- `version` - PRD version
- `branch` - Git branch name
- `files_changed` - List of modified files
- `tags` - Categorization tags

**Benefits:**
- Dashboard can filter by status, tags, files
- Metrics aggregation (count changes, track patterns)
- Trend analysis over time
- Still human-readable (prose below frontmatter)

### Files modified

- `tools/ralph/cli/prompts/partials/workflow.md` - Added YAML frontmatter template
- `CLAUDE.md` - Added Ralph activity log format specification
- `docs/knowledge/ralph-dashboard/activity.md` - Updated log format documentation

### Knowledge base updated

- `docs/knowledge/ralph-cli/activity-logs.md` - New chapter documenting activity log format
- `docs/knowledge/ralph-cli/index.json` - Added activity-logs page to navigation

---

## Task-Oriented Prompt Refactor

**Time:** 2026-01-27 ~11:30 CR

### What was done

Refactored the Ralph prompt system to be task-oriented, leveraging Claude Code's native task tracking capabilities. Instead of loading all instructions upfront, Claude now creates tasks for each phase and loads instructions on-demand.

**New prompt structure:**
- Main prompt defines 5 phases as tasks (understand, plan, implement, verify, complete)
- Each task references its instruction file
- Claude creates tasks upfront and progresses through them
- Task descriptions capture progress and findings

**Benefits:**
- Leaner prompts = less token usage
- Visible progress in Claude Code UI
- On-demand instruction loading
- Clear completion criteria per phase

**Files consolidated:**
- Removed `rules.md` (content moved to prompt.md)
- Removed `gotchas.md` (content moved to completion.md)
- Removed `prompts/partials/workflow.md` (no longer needed)

### Files modified

- `tools/ralph/cli/prompt.md` - Complete rewrite to task-oriented structure
- `tools/ralph/cli/prompts/feedback.md` - Updated to match task-oriented style
- `tools/ralph/cli/instructions/context.md` - Cleaned up, fixed book paths
- `tools/ralph/cli/instructions/completion.md` - Merged documentation updates from gotchas.md
- `tools/ralph/cli/instructions/activity-log.md` - Added YAML frontmatter
- `tools/ralph/cli/lib/claude.elv` - Removed workflow partial loading

### Files removed

- `tools/ralph/cli/instructions/rules.md`
- `tools/ralph/cli/instructions/gotchas.md`
- `tools/ralph/cli/prompts/partials/workflow.md`
- `tools/ralph/cli/prompts/partials/` (directory)

### Knowledge base updated

- `docs/knowledge/ralph-cli/prompt-system.md` - New chapter documenting prompt architecture
- `docs/knowledge/ralph-cli/index.json` - Added prompt-system page

---

## Configurable Timezone Setting

**Time:** 2026-01-27 ~12:00 CR

### What was done

Added a configurable timezone setting to the dashboard. Claude now reads the timezone from dashboard settings instead of using hardcoded CR timezone. This makes Ralph usable for anyone in any timezone.

**Dashboard changes:**
- Added timezone picker to Settings page with common timezones
- Added `timezone` field to settings.json schema
- Default: America/Costa_Rica

**CLI changes:**
- claude.elv reads timezone from `dashboard/settings.json`
- Prompt uses `TZ={{TIMEZONE}} date` command
- Instructions updated to use dynamic timezone

### Files modified

- `tools/ralph/dashboard/src/app/settings/page.tsx` - Added timezone picker UI
- `tools/ralph/dashboard/src/app/api/settings/route.ts` - Added timezone to Settings type
- `tools/ralph/dashboard/settings.json` - Added timezone field
- `tools/ralph/cli/prompt.md` - Dynamic timezone placeholder
- `tools/ralph/cli/instructions/activity-log.md` - Dynamic timezone placeholder
- `tools/ralph/cli/lib/claude.elv` - Read timezone from dashboard settings
- `docs/knowledge/ralph-dashboard/settings.md` - Documented timezone setting

---

## Smart Story Selection

**Time:** 2026-01-27 ~17:07 CR

### What was done

Implemented intelligent story selection that optimizes for context retention and throughput. Instead of picking the first runnable story, Ralph now scores all candidates and picks the optimal one.

**Scoring model (weighted sum):**
- Tree proximity (5.0) - Same epic (1.0), same phase (0.5), other (0.0)
- Tag overlap (3.0) - Jaccard similarity with last-completed story
- Blocker value (2.0) - How many stories does this unblock
- User priority (1.0) - PRD `priority` field (0-10)
- Inverse complexity (0.5) - Simpler stories (fewer acceptance criteria) break ties

**Why this matters:**
- Completing related stories together means Claude retains patterns, files, architecture
- "Warm" context between related stories vs "cold start" on every story
- High-blocker stories get priority to maximize parallelism

**State tracking:**
- Added `last_completed` to state.json
- Set when story is merged
- Preserved across state reset
- Used to score next story for context affinity

**New functions in prd.elv:**
- `score-story` - Calculate composite score
- `calc-tree-proximity` - Phase/epic distance
- `calc-tag-overlap` - Jaccard similarity using jq
- `calc-blocker-value` - Count downstream dependents
- `calc-inverse-complexity` - 1/acceptance_criteria_count
- `get-story-priority` - Read PRD priority field

**Updated functions:**
- `get-next-story` - Now accepts optional `&last-completed`, scores all runnable candidates
- `get-next-story-for-version` - Passes through last-completed parameter

**New functions in state.elv:**
- `set-last-completed` - Track last merged story
- `get-last-completed` - Retrieve for scoring

**Integration points:**
- `ralph.elv` - Passes last-completed when calling get-next-story
- `pr.elv` - Sets last-completed when story is merged

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added scoring functions, updated get-next-story
- `tools/ralph/cli/lib/state.elv` - Added last_completed tracking
- `tools/ralph/cli/lib/pr.elv` - Set last-completed on merge
- `tools/ralph/cli/ralph.elv` - Pass last-completed to story selection

### Files created

- `docs/knowledge/ralph-cli/smart-story-selection.md` - Feature documentation

---

## Dashboard UI: Smart Selection Fields

**Time:** 2026-01-27 ~17:30 CR

### What was done

Added UI to display the new smart story selection fields (priority, tags, last_completed) in the dashboard.

**Type updates (`types.ts`):**
- `Story` - added `priority?: number` and `tags?: string[]`
- `State` - added `last_completed`, `last_error`, `failure_count`

**Home page (`current-work.tsx`):**
- Shows "Last completed" with story ID and title when idle
- Links to story detail page

**Story cards (`story-card.tsx`):**
- Priority badge (orange, with up arrow) next to story ID
- Tags badges below dependencies (shows first 3, +N for more)

**Story detail page (`stories/[id]/page.tsx`):**
- Priority badge in header next to status
- Tags row below branch name with all tags displayed

### Files modified

- `tools/ralph/dashboard/src/lib/types.ts` - Added priority, tags, last_completed, failure tracking fields
- `tools/ralph/dashboard/src/components/current-work.tsx` - Added lastCompletedStory prop, display when idle
- `tools/ralph/dashboard/src/components/story-card.tsx` - Added priority badge and tags display
- `tools/ralph/dashboard/src/app/stories/[id]/page.tsx` - Added priority badge and tags row
- `tools/ralph/dashboard/src/app/page.tsx` - Pass lastCompletedStory to CurrentWork

---

## Dashboard: Claude-Powered PRD Management

**Time:** 2026-01-27 ~18:42 CR

### What was done

Refactored the dashboard's PRD management to have Claude handle all file modifications. Previously, the dashboard code directly wrote to PRD files. Now all changes go through Claude for consistency and to enable AI-assisted editing.

**Core changes:**

1. **Shared Claude utility (`lib/claude.ts`)**
   - Temp file I/O for reliable communication
   - Writes prompt to `/tmp/claude-prompt-{uuid}.md`
   - Instructs Claude to write JSON response to `/tmp/claude-response-{uuid}.json`
   - Reads response file, parses JSON, cleans up
   - Avoids shell escaping issues and size limits

2. **All PUT handlers now prompt Claude to write PRD**
   - `/api/prd/refine` - Claude applies refined descriptions and acceptance criteria
   - `/api/prd/generate` - Claude adds new stories with proper IDs
   - `/api/prd/story` - Claude updates individual stories

3. **Iterative refinement flow**
   - Claude suggests both `suggested_description` and `suggested_acceptance`
   - User reviews suggestions in modal
   - Click pencil icon → prompt Claude to refine suggestions for that specific story
   - Claude regenerates just that story's suggestions
   - Repeat until happy
   - Click "Apply" → Claude writes to PRD

4. **New edit endpoint (`/api/prd/refine/edit`)**
   - Takes user feedback and current suggestions
   - Regenerates suggestions for single story
   - Updates only that story in the UI state

**UI improvements:**
- Refinement cards now show title, description, and acceptance criteria
- Edit button opens prompt input (not manual textarea)
- Loading state for individual story refinement

### Files created

- `tools/ralph/dashboard/src/lib/claude.ts` - Shared Claude communication utility
- `tools/ralph/dashboard/src/app/api/prd/refine/edit/route.ts` - Single-story refinement endpoint

### Files modified

- `tools/ralph/dashboard/src/app/api/prd/refine/route.ts` - Use claude.ts, prompt includes description
- `tools/ralph/dashboard/src/app/api/prd/generate/route.ts` - Use claude.ts, Claude writes PRD
- `tools/ralph/dashboard/src/app/api/prd/story/route.ts` - Use claude.ts, Claude writes PRD
- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx` - Updated Refinement type, iterative edit UI

---

## Story Modal: Full Preview with Iteration

**Time:** 2026-01-27 ~18:50 CR

### What was done

Updated the story edit modal to show full previews of suggested changes and allow iterative refinement with user feedback.

**Type fixes:**
- Changed all references from old `RelatedUpdate` to `SuggestedUpdate`
- Fixed property names from camelCase to snake_case (`suggestedAcceptance` → `suggested_acceptance`)
- Added `updatedDescription` state for tracking description changes

**API response handling:**
- Updated `handleAnalyze` to use new API format (`target`, `related_updates`)
- Maps response to local state with description, acceptance, and intent
- Enriched `related_updates` with titles from original stories

**Review UI redesign:**
- Replaced full cards with compact rows showing summary info
- Each row shows: story ID, title, criteria count, description change indicator
- Added "Preview" button that opens nested modal with full details

**Preview modal features:**
- Shows suggested description in highlighted box
- Shows numbered acceptance criteria list
- Displays reason for related story updates (amber callout)
- Iterate functionality: textarea for user feedback + "Regenerate" button
- Calls `/api/prd/refine/edit` API to regenerate suggestions for specific story
- Updates both preview and parent state when regeneration completes
- Handles cascading updates when iteration affects related stories

### Files modified

- `tools/ralph/dashboard/src/components/story-modal.tsx` - Full rewrite of review UI, added preview modal, iteration functionality
- `tools/ralph/dashboard/src/app/api/prd/story/route.ts` - Enrich related_updates with title

### Knowledge base updated

- `docs/knowledge/ralph-dashboard/prd-tools.md` - Updated Story Edit section with preview modal and iteration docs

---

## CLI: Temp File Pattern for Claude Invocations

**Time:** 2026-01-27 ~19:30 CR

### What was done

Added a shared `run-claude` function to the CLI that uses temp files for prompt handling, matching the dashboard's `lib/claude.ts` pattern. This avoids shell escaping issues and size limits.

**New function in claude.elv:**
```elvish
fn run-claude {|prompt &timeout=$nil &stream-json=$false|
  # Write prompt to temp file
  # Run claude < temp-file
  # Return [&success=bool &output=string &error=string]
  # Cleanup temp file
}
```

**Benefits:**
- No shell escaping issues with quotes, newlines, JSON in prompts
- No command line size limits
- Consistent pattern with dashboard
- Easier debugging (can inspect temp files on failure)

**Updated 14 call sites across 4 files:**
- `claude.elv` (9): validate-story, refine-prd, add-stories, check-duplicate, check-reverse-deps, analyze-batch, propagate-external-deps, related analysis, generate-commit-message
- `gotchas.elv` (3): compaction, extraction, feedback extraction
- `pr.elv` (1): PR description enhancement
- `release.elv` (1): hotfix with stream-json

**Note:** gotchas.elv has its own local `run-claude` function to avoid circular dependency (claude.elv imports gotchas.elv).

### Files modified

- `tools/ralph/cli/lib/claude.elv` - Added run-claude function, updated 9 call sites
- `tools/ralph/cli/lib/gotchas.elv` - Added local run-claude function, updated 3 call sites
- `tools/ralph/cli/lib/pr.elv` - Added claude import, updated 1 call site
- `tools/ralph/cli/lib/release.elv` - Added claude import, updated 1 call site

---

## Dashboard: Fix Claude CWD for Refine Operations

**Time:** 2026-01-27 ~19:45 CR

### What was done

Fixed the dashboard's Claude invocations which had stopped working. The issue was that Claude was running in `RALPH_CLI_DIR` (tools/ralph/cli) but should run from `PROJECT_ROOT` (trinity/) for consistent behavior.

**Changes:**
- Changed default `cwd` from `RALPH_CLI_DIR` to `PROJECT_ROOT`
- Improved error reporting to include both stdout and stderr

**Why this matters:**
- Claude runs normally from anywhere on the system
- Running from project root gives Claude proper context
- The refine/generate/story edit operations now work again

### Files modified

- `tools/ralph/dashboard/src/lib/claude.ts` - Changed default cwd to PROJECT_ROOT, added stderr to error output

---

## Dashboard: Background Task System for Claude Operations

**Time:** 2026-01-27 ~22:22 CR

### What was done

Implemented a comprehensive background task system so Claude operations (refine, generate, story-edit) run without blocking the UI. Users get notifications when tasks complete and can view/apply results later.

**Architecture:**

1. **Task Queue (`lib/tasks.ts`)**
   - File-based task store (`tasks.json`) with locking
   - Sequential processing (only 1 task runs at a time)
   - Task states: queued → running → complete/failed
   - Auto-cleanup of old tasks (keeps last 50)

2. **Task Handlers (`lib/task-handlers.ts`)**
   - `runRefineTask` - Calls Claude to analyze stories, returns refinements
   - `runGenerateTask` - Calls Claude to generate stories from description
   - `runStoryEditTask` - Calls Claude to update a single story

3. **API Endpoints (`/api/tasks`)**
   - `GET /api/tasks?active=true` - List queued/running tasks
   - `GET /api/tasks?status=complete,failed&limit=10` - Recent tasks
   - `POST /api/tasks` - Create new task (triggers queue processing)
   - `GET /api/tasks/[id]` - Get single task details

4. **React Context (`TaskProvider`)**
   - Polls `/api/tasks` every 2 seconds
   - Tracks active and recent tasks
   - Detects task completion, triggers notifications
   - Exports `isTaskRunning(type)` for scoped loading states
   - Exports `createTask(type, version, params)` for triggering tasks

5. **UI Components**
   - `TaskIndicator` - Dropdown in sidebar showing active/recent tasks
   - `TaskResultsModal` - View completed task results, select and apply
   - `ToastProvider` / `useToast` - In-app toast notifications

6. **Scoped Loading States**
   - Refine button shows loader when refine task is running
   - Generate button shows loader when generate task is running
   - Both remain responsive (don't block other UI)

**User flow:**
1. Click Refine → Modal opens with "Start Analysis" button
2. Click "Start Analysis" → Task created, modal closes
3. TaskIndicator shows spinning loader + "Refine"
4. When complete → Toast notification with "View Results" link
5. Browser notification (if permitted)
6. Click "View Results" → TaskResultsModal opens
7. Select refinements to apply → Click "Apply" → PRD updated

### Files created

- `tools/ralph/dashboard/src/lib/tasks.ts` - Task queue with file locking
- `tools/ralph/dashboard/src/lib/task-handlers.ts` - Task execution handlers
- `tools/ralph/dashboard/src/app/api/tasks/route.ts` - Task list/create API
- `tools/ralph/dashboard/src/app/api/tasks/[id]/route.ts` - Single task API
- `tools/ralph/dashboard/src/components/task-provider.tsx` - React context
- `tools/ralph/dashboard/src/components/task-indicator.tsx` - Sidebar dropdown
- `tools/ralph/dashboard/src/components/task-results-modal.tsx` - Results viewer
- `tools/ralph/dashboard/src/components/toast-provider.tsx` - Toast system
- `tools/ralph/dashboard/src/hooks/use-toast.ts` - Toast hook
- `tools/ralph/dashboard/src/components/ui/dropdown-menu.tsx` - shadcn component

### Files modified

- `tools/ralph/dashboard/src/app/layout.tsx` - Added TaskProvider, ToastProvider, TaskResultsModal
- `tools/ralph/dashboard/src/components/sidebar.tsx` - Added TaskIndicator
- `tools/ralph/dashboard/src/components/stories-header.tsx` - Added scoped loading states
- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx` - Simplified to just trigger tasks
- `tools/ralph/dashboard/package.json` - Added uuid dependency

---

