# Ralph Activity Log - 2026-01-27

## Knowledge Base: PRD Structure Documentation

**Time:** 2026-01-27 ~11:00 CR

### What was done

Added comprehensive PRD structure documentation to the Ralph knowledge base. The existing docs covered CLI usage, workflows, and FAQ well, but lacked documentation explaining how the actual PRD files are structured.

**New documentation covers:**
- File organization (versioned JSON files: v0.1.json, v1.0.json, v2.0.json)
- Top-level structure (title, shortTitle, description, phases, epics, stories)
- Phase and epic definitions (separate arrays, not nested)
- Complete story schema with required and optional fields
- Story ID format (`1.2.3` numeric vs Trinity's planned `STORY-1.2.3`)
- Dependency syntax (same-version, cross-version, phase/epic/story refs)
- Two-stage completion (`passes` vs `merged` explained in detail)
- Human testing gates workflow
- External dependencies (`external_deps` and `external_deps_report`)
- State.json schema for runtime state tracking
- Complete story example showing all fields

### Files created

- `docs/knowledge/ralph/prd-structure.md` - PRD file structure documentation

### Files modified

- `docs/knowledge/ralph/index.json` - Added prd-structure page to navigation

---

## Knowledge Base: Documentation Audit & Improvements

**Time:** 2026-01-27 ~12:00 CR

### What was done

Audited Ralph implementation against documentation to identify gaps and inaccuracies. Found several undocumented features and missing flags, then updated docs to match actual code.

**CLI Reference updates:**
- Added missing `--refine-prd [ID]` flag with examples
- Added missing `--add-stories "desc"` flag with examples
- Improved descriptions for all flags to match help text in ui.elv
- Added "PRD Management Flags" section

**PRD Structure updates:**
- Clarified story ID format - both `1.2.3` and `STORY-1.2.3` work (normalized internally)
- Added missing `version` field to state schema
- Added missing `checkpoints` field to state schema

**New Advanced Features documentation:**
- Reverse dependency management (`--auto-add-reverse-deps`)
- Learning extraction and gotchas system (30-day compaction)
- Release workflow with hotfix loop
- Duplicate detection (expands on FAQ)
- Story validation and clarification
- Related story updates

### Files created

- `docs/knowledge/ralph/story-validation.md` - Story validation and clarification
- `docs/knowledge/ralph/duplicate-detection.md` - Duplicate detection workflow
- `docs/knowledge/ralph/reverse-dependencies.md` - Reverse dependency management
- `docs/knowledge/ralph/learning-extraction.md` - Learning extraction and gotchas compaction
- `docs/knowledge/ralph/release-workflow.md` - Release workflow with hotfix loop

### Files modified

- `docs/knowledge/ralph/cli-reference.md` - Added missing flags, improved descriptions
- `docs/knowledge/ralph/prd-structure.md` - Clarified story IDs, added state fields
- `docs/knowledge/ralph/index.json` - Added all new pages to navigation

---

## Knowledge Base: Dashboard Documentation Update

**Time:** 2026-01-27 ~13:00 CR

### What was done

Audited dashboard documentation against actual implementation. Found 95% alignment with some undocumented features. Updated docs to match current state.

**Additions:**
- Story Detail Page (`/stories/[id]`) - full story view with deps, PR tracking
- Settings Page - theme selection, default version
- System theme option (follows OS preference)
- Graph features: custom layouts, depth-based edge colors, dead-end toggle, external deps toggle, minimap
- Graph Layouts section - custom saved layouts per version

**Fixes:**
- Corrected npm scripts (`dev:local` → `dev:terminal`, added `dev:next`)

### Files modified

- `docs/knowledge/ralph/dashboard.md` - Added missing features, fixed scripts

---

## Knowledge Base: Reorganize Ralph into CLI and Dashboard Books

**Time:** 2026-01-27 ~14:00 CR

### What was done

Split the single "Ralph" book into two separate books for better organization:

**Ralph CLI** (`docs/knowledge/ralph-cli/`) - 10 pages:
- Overview, CLI Reference, Workflows, PRD Structure
- Story Validation, Duplicate Detection, Reverse Dependencies
- Learning Extraction, Release Workflow, FAQ

**Ralph Dashboard** (`docs/knowledge/ralph-dashboard/`) - 5 pages:
- Overview (pages summary)
- Graph (visualization, layouts, toggles)
- Terminal (PTY, tmux, ngrok)
- PRD Tools (wizard modals)
- Themes (cyber themes, mobile responsiveness)

### Files created

- `docs/knowledge/ralph-cli/index.json`
- `docs/knowledge/ralph-dashboard/index.json`
- `docs/knowledge/ralph-dashboard/index.md`
- `docs/knowledge/ralph-dashboard/graph.md`
- `docs/knowledge/ralph-dashboard/terminal.md`
- `docs/knowledge/ralph-dashboard/prd-tools.md`
- `docs/knowledge/ralph-dashboard/themes.md`

### Files moved

- All CLI docs moved from `ralph/` to `ralph-cli/`

### Files deleted

- `docs/knowledge/ralph/` (entire directory)

---

## Knowledge Base: Add Missing Dashboard Chapters

**Time:** 2026-01-27 ~14:30 CR

### What was done

Added missing chapter pages for each dashboard page:
- Stories (with story detail, blocked indicators)
- Metrics (token usage, cost tracking, story breakdown)
- Activity (daily logs, project filtering)
- Knowledge & Gotchas (book/chapter structure, navigation)
- Settings (theme, default version, persistence)

Updated index.md to be a cleaner overview with links to chapters.

### Files created

- `docs/knowledge/ralph-dashboard/stories.md`
- `docs/knowledge/ralph-dashboard/metrics.md`
- `docs/knowledge/ralph-dashboard/activity.md`
- `docs/knowledge/ralph-dashboard/knowledge-gotchas.md`
- `docs/knowledge/ralph-dashboard/settings.md`

### Files modified

- `docs/knowledge/ralph-dashboard/index.json` - Added new pages
- `docs/knowledge/ralph-dashboard/index.md` - Simplified to overview with links

---

## Gotchas: Reorganize Dashboard into Next.js and Node

**Time:** 2026-01-27 ~15:00 CR

### What was done

Split the "dashboard" gotchas book into two more specific books:

**nextjs/** - React/Next.js gotchas:
- Hydration issues
- iOS fullscreen fallback
- shadcn CLI usage
- Mobile hamburger menu

**node/** - Node.js native module gotchas:
- node-pty build issues

### Files created

- `docs/gotchas/node/index.json`
- `docs/gotchas/node/index.md`

### Files renamed/modified

- `docs/gotchas/dashboard/` → `docs/gotchas/nextjs/`
- `docs/gotchas/nextjs/index.json` - Updated title and description
- `docs/gotchas/nextjs/index.md` - Removed node-pty section, updated title

---

## Checkpoint System for Resume Functionality

**Time:** 2026-01-27 ~16:00 CR

### What was done

Implemented a checkpoint system for Ralph CLI that tracks progress at each major phase. When Ralph crashes or times out during Claude execution, the `--resume` flag now knows which phase to skip to instead of restarting from scratch.

**Checkpoint stages:**
- `branch_created` - Story selected, branch ready
- `validation_complete` - Story validated, deps checked
- `claude_started` - Claude invoked (can't resume mid-Claude)
- `claude_complete` - Signal detected, ready for PR
- `pr_created` - PR exists, waiting for merge

**State functions added to state.elv:**
- `save-checkpoint` - Save checkpoint with story ID, stage, timestamp, attempt, and stage-specific data
- `get-checkpoint` - Retrieve a specific checkpoint
- `has-checkpoint` - Check if a checkpoint exists
- `clear-checkpoints` - Remove all checkpoints for a story

**Resume logic in ralph.elv:**
- When `--resume` is passed, checks for existing checkpoints
- Skips to the appropriate phase based on most advanced checkpoint
- `pr_created` or `claude_complete` → skip to PR flow
- `validation_complete` → skip to Claude execution
- `branch_created` → skip to validation

**Checkpoint data stored:**
- `branch_created`: branch name, current commit
- `validation_complete`: clarification text (if any)
- `claude_started`: attempt number
- `claude_complete`: signal type, commit hash
- `pr_created`: PR URL

**Checkpoint cleanup:**
- Cleared when story completes (merged)
- Cleared when story is blocked
- Cleared during `--retry-clean`

### Files modified

- `tools/ralph/cli/lib/state.elv` - Added checkpoint functions (save, get, has, clear)
- `tools/ralph/cli/ralph.elv` - Added checkpoint saves at 5 phases, resume logic, checkpoint clears
