# Ralph Activity Log - 2026-01-28

## Fix: Dashboard Refine Endpoint Timeout

**Time:** 2026-01-28 ~05:30 SAST

### Problem

The `/api/prd/refine` endpoint was failing with:
```
Signal: SIGTERM
Killed: true
POST /api/prd/refine 500 in 2.0min
```

The endpoint was timing out after the default 2-minute timeout when trying to analyze 91 stories. The `/api/prd/story` endpoint worked fine because it only handles one story at a time.

### Root Cause

The `runClaude()` helper has a default timeout of 120000ms (2 minutes). Analyzing all pending stories takes longer than this, causing Node.js to kill the Claude process with SIGTERM.

### Solution

1. Increased refine endpoint timeout to 10 minutes (600000ms)
2. Added debug logging to `runClaude()` and refine route for future diagnosis:
   - Request ID, file paths, CWD, prompt length
   - On error: exit code, signal, killed status, stdout/stderr

### Files modified

- `tools/ralph/dashboard/src/app/api/prd/refine/route.ts` - Added timeout option and debug logging
- `tools/ralph/dashboard/src/lib/claude.ts` - Added debug logging for Claude execution
- `docs/knowledge/ralph-dashboard/prd-tools.md` - Added Timeouts section documenting limits

### Commit

`8b3557f` - fix(dashboard): increase refine timeout to 10 minutes and add debug logging

---

## Refactor: Standardize Claude timeout to 15 minutes

**Time:** 2026-01-28 ~05:35 SAST

### What was done

Changed all Claude CLI calls to use a consistent 15-minute timeout instead of varying timeouts per endpoint.

### Changes

- Set default timeout in `runClaude()` to 900000ms (15 minutes)
- Removed all per-endpoint timeout overrides - they now use the default
- Updated prd-tools.md documentation

### Files modified

- `tools/ralph/dashboard/src/lib/claude.ts` - Default timeout now 15 min
- `tools/ralph/dashboard/src/app/api/prd/refine/route.ts` - Removed timeout overrides
- `tools/ralph/dashboard/src/app/api/prd/refine/edit/route.ts` - Removed timeout override
- `tools/ralph/dashboard/src/app/api/prd/story/route.ts` - Removed timeout override
- `tools/ralph/dashboard/src/app/api/prd/generate/route.ts` - Removed timeout override
- `docs/knowledge/ralph-dashboard/prd-tools.md` - Updated timeout docs

---

## UI: Add loading messages for long-running Claude operations

**Time:** 2026-01-28 ~05:45 SAST

### What was done

Added user-friendly loading states with explanatory messages for all Claude-powered PRD operations. Users now see clear feedback that operations may take time.

### Changes

**RefineStoriesModal:**
- Analyze step shows spinner with "Analyzing stories..." and explanation
- Apply button shows "Applying refinements to PRD..." message

**GenerateStoriesModal:**
- Generate step shows spinner with "Generating stories..." and explanation
- Add button shows "Adding stories to PRD..." message

**StoryModal:**
- Analyze step shows spinner with "Analyzing changes..." and explanation
- Apply button shows "Applying updates to PRD..." message
- Regenerate shows "Regenerating suggestions..." message

### Files modified

- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx`
- `tools/ralph/dashboard/src/components/story-modal.tsx`

---

## UI: Add loading states to Settings page dropdowns

**Time:** 2026-01-28 ~05:55 SAST

### What was done

Added loading states to the Settings page dropdowns for Default Version and Timezone:
- Shows "Loading..." spinner while fetching initial settings
- Shows "Saving..." spinner while saving changes
- Disables dropdowns during loading/saving operations

### Files modified

- `tools/ralph/dashboard/src/app/settings/page.tsx`

---

## UI: Add loading skeletons to Stories page

**Time:** 2026-01-28 ~06:00 SAST

### What was done

Improved loading states for the Stories page:
- Added loading.tsx with skeleton UI matching the page layout
- Improved StoriesList Suspense fallback to show skeleton dropdowns for Phase/Epic filters
- Skeletons show placeholder shapes for filters, tabs, and story cards

### Files created

- `tools/ralph/dashboard/src/app/stories/loading.tsx`

### Files modified

- `tools/ralph/dashboard/src/components/stories-list.tsx`

---

## UI: Cyber-dark theme fixes for PRD modals

**Time:** 2026-01-28 ~06:15 SAST

### What was done

Multiple cyber-dark theme improvements for the Refine and Generate Stories modals:
- Step indicator uses accent (yellow) color for active step
- Modal subtitles use secondary-foreground color
- Default button style changed to transparent with cyan border/text (matches SplitButton)
- Added icons to main action buttons (Sparkles, Wand2)
- Text under textarea uses muted-foreground

### Files modified

- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx`
- `tools/ralph/dashboard/src/components/story-modal.tsx`
- `tools/ralph/dashboard/src/components/ui/button.tsx`

---

## Feature: Task soft deletes and read tracking

**Time:** 2026-01-28 ~00:20 CR

### What was done

Implemented soft deletes for background tasks with read/unread tracking:

1. **Database migration** - Added `read_at` and `deleted_at` columns to tasks table
2. **Task store refactoring** - Changed from single `pendingTask` to `pendingTasks` array to support multiple concurrent tasks
3. **Task indicator improvements**:
   - Shows only unread tasks in dropdown
   - Cyber-dark badge styling with accent color and hover effects
   - Click navigates to results modal
4. **StoryEditModal** - New modal for story-edit task results following same wizard pattern as Refine/Generate
5. **Navigation fixes** - Tasks now properly navigate and open the correct modal with pre-populated data

### Key patterns

- `pendingTasks` array persisted to localStorage for navigation survival
- Store subscription pattern for detecting pending tasks after page load
- Full page navigation (`window.location.href`) instead of `router.push()` for reliability

### Files created

- `tools/ralph/dashboard/src/lib/db/migrations/004_task_soft_delete.sql`
- `tools/ralph/dashboard/src/lib/task-store.ts`
- `tools/ralph/dashboard/src/app/tasks/page.tsx`
- `tools/ralph/dashboard/src/app/api/tasks/clear/route.ts`
- `docs/knowledge/ralph-dashboard/tasks.md`
- `docs/knowledge/ralph-dashboard/database.md`

### Files modified

- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx` - Added StoryEditModal
- `tools/ralph/dashboard/src/components/stories-header.tsx` - Handle story-edit tasks
- `tools/ralph/dashboard/src/components/task-indicator.tsx` - Navigation + styling
- `tools/ralph/dashboard/src/components/task-provider.tsx` - Use new store
- `tools/ralph/dashboard/src/app/api/tasks/route.ts` - Soft delete support
- `tools/ralph/dashboard/src/app/api/tasks/[id]/route.ts` - Read/delete/restore actions

---

## Feature: Dashboard Execution Loop (CLI Consolidation)

**Time:** 2026-01-28 ~20:40 CR

### What was done

Consolidated the CLI execution functionality into the dashboard. This ports the full story execution loop from the Elvish CLI to TypeScript, enabling running the autonomous development loop directly from the dashboard UI.

### New capabilities

1. **Smart Story Selection** - Uses scoring algorithm (tree proximity 5.0, tag overlap 3.0, blocker value 2.0, priority 1.0, inverse complexity 0.5) to pick optimal next story
2. **Execution State Management** - Checkpoints for resume capability across browser sessions
3. **Interactive Gates** - Modal dialogs for validation, external deps, and PR review decisions
4. **Git Operations** - Branch creation, commits, PRs, and merging from the dashboard
5. **Run Page UI** - Configuration panel, progress display, activity log, and gate modals

### Architecture

The execution is split into modules:
- `scoring.ts` - Smart story selection algorithm
- `run-state.ts` - State persistence with checkpoints and failure tracking
- `git.ts` - Git operations (branch, commit, push, PR)
- `execution.ts` - Main execution loop orchestration

### Files created

- `tools/ralph/dashboard/src/lib/scoring.ts` - Story scoring and selection
- `tools/ralph/dashboard/src/lib/run-state.ts` - State management with writes
- `tools/ralph/dashboard/src/lib/git.ts` - Git operations for execution
- `tools/ralph/dashboard/src/lib/execution.ts` - Main execution loop
- `tools/ralph/dashboard/src/app/api/run/route.ts` - API endpoint
- `tools/ralph/dashboard/src/app/run/page.tsx` - Run page UI with gate modals

### Files modified

- `tools/ralph/dashboard/src/components/sidebar.tsx` - Added Run nav item

### Design decisions

- Gates (validation, external deps, PR review) are handled via modal dialogs instead of CLI prompts
- Execution runs iteration-by-iteration, pausing at gates for user input
- Auto mode skips gates and makes reasonable assumptions
- Story queue display shows scoring breakdown for transparency

---

## Feature: Run Modal Wizard

**Time:** 2026-01-28 ~21:15 CR

### What was done

Rebuilt the Run page to use a wizard modal interface following the same pattern as RefineStoriesModal and GenerateStoriesModal.

### Key changes

1. **Wizard modal** (`run-modal.tsx`) with steps:
   - Config (version, story, mode, options)
   - Ext Deps (if story has external_deps)
   - Validation (if story has issues)
   - Execute (Claude running with logs)
   - Review (PR ready, merge or feedback)
   - Done (success, option to run next)

2. **Mode selection**:
   - Manual (default) - user controls individual options
   - Autopilot - all options enabled, runs without stopping

3. **Gate order fixed**: External deps checked before validation (cheaper check, skip early)

4. **Feedback loop**: Request Changes at Review step loops back to Execute with feedback injected

### Files created

- `tools/ralph/dashboard/src/components/run-modal.tsx`

### Files modified

- `tools/ralph/dashboard/src/app/run/page.tsx` - Simplified to trigger modal
- `tools/ralph/dashboard/src/lib/execution.ts` - Reordered gates
- `tools/ralph/dashboard/src/lib/run-state.ts` - Added external_deps_complete checkpoint
- `docs/knowledge/ralph-dashboard/execution.md` - Updated documentation

---
