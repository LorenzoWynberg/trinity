# Ralph Activity Log - 2026-01-28

## Fix: Dashboard Refine Endpoint Timeout

**Time:** 2026-01-28 ~05:30 SAST

### Problem

The `/api/prd/refine` endpoint was failing with:
```
Signal: SIGTERM
Killed: true
POST /api/prd/refine 500 in 2.0min
```

The endpoint was timing out after the default 2-minute timeout when trying to analyze 91 stories. The `/api/prd/story` endpoint worked fine because it only handles one story at a time.

### Root Cause

The `runClaude()` helper has a default timeout of 120000ms (2 minutes). Analyzing all pending stories takes longer than this, causing Node.js to kill the Claude process with SIGTERM.

### Solution

1. Increased refine endpoint timeout to 10 minutes (600000ms)
2. Added debug logging to `runClaude()` and refine route for future diagnosis:
   - Request ID, file paths, CWD, prompt length
   - On error: exit code, signal, killed status, stdout/stderr

### Files modified

- `tools/ralph/dashboard/src/app/api/prd/refine/route.ts` - Added timeout option and debug logging
- `tools/ralph/dashboard/src/lib/claude.ts` - Added debug logging for Claude execution
- `docs/knowledge/ralph-dashboard/prd-tools.md` - Added Timeouts section documenting limits

### Commit

`8b3557f` - fix(dashboard): increase refine timeout to 10 minutes and add debug logging

---

## Refactor: Standardize Claude timeout to 15 minutes

**Time:** 2026-01-28 ~05:35 SAST

### What was done

Changed all Claude CLI calls to use a consistent 15-minute timeout instead of varying timeouts per endpoint.

### Changes

- Set default timeout in `runClaude()` to 900000ms (15 minutes)
- Removed all per-endpoint timeout overrides - they now use the default
- Updated prd-tools.md documentation

### Files modified

- `tools/ralph/dashboard/src/lib/claude.ts` - Default timeout now 15 min
- `tools/ralph/dashboard/src/app/api/prd/refine/route.ts` - Removed timeout overrides
- `tools/ralph/dashboard/src/app/api/prd/refine/edit/route.ts` - Removed timeout override
- `tools/ralph/dashboard/src/app/api/prd/story/route.ts` - Removed timeout override
- `tools/ralph/dashboard/src/app/api/prd/generate/route.ts` - Removed timeout override
- `docs/knowledge/ralph-dashboard/prd-tools.md` - Updated timeout docs

---

## UI: Add loading messages for long-running Claude operations

**Time:** 2026-01-28 ~05:45 SAST

### What was done

Added user-friendly loading states with explanatory messages for all Claude-powered PRD operations. Users now see clear feedback that operations may take time.

### Changes

**RefineStoriesModal:**
- Analyze step shows spinner with "Analyzing stories..." and explanation
- Apply button shows "Applying refinements to PRD..." message

**GenerateStoriesModal:**
- Generate step shows spinner with "Generating stories..." and explanation
- Add button shows "Adding stories to PRD..." message

**StoryModal:**
- Analyze step shows spinner with "Analyzing changes..." and explanation
- Apply button shows "Applying updates to PRD..." message
- Regenerate shows "Regenerating suggestions..." message

### Files modified

- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx`
- `tools/ralph/dashboard/src/components/story-modal.tsx`

---

## UI: Add loading states to Settings page dropdowns

**Time:** 2026-01-28 ~05:55 SAST

### What was done

Added loading states to the Settings page dropdowns for Default Version and Timezone:
- Shows "Loading..." spinner while fetching initial settings
- Shows "Saving..." spinner while saving changes
- Disables dropdowns during loading/saving operations

### Files modified

- `tools/ralph/dashboard/src/app/settings/page.tsx`

---

## UI: Add loading skeletons to Stories page

**Time:** 2026-01-28 ~06:00 SAST

### What was done

Improved loading states for the Stories page:
- Added loading.tsx with skeleton UI matching the page layout
- Improved StoriesList Suspense fallback to show skeleton dropdowns for Phase/Epic filters
- Skeletons show placeholder shapes for filters, tabs, and story cards

### Files created

- `tools/ralph/dashboard/src/app/stories/loading.tsx`

### Files modified

- `tools/ralph/dashboard/src/components/stories-list.tsx`

---

## UI: Cyber-dark theme fixes for PRD modals

**Time:** 2026-01-28 ~06:15 SAST

### What was done

Multiple cyber-dark theme improvements for the Refine and Generate Stories modals:
- Step indicator uses accent (yellow) color for active step
- Modal subtitles use secondary-foreground color
- Default button style changed to transparent with cyan border/text (matches SplitButton)
- Added icons to main action buttons (Sparkles, Wand2)
- Text under textarea uses muted-foreground

### Files modified

- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx`
- `tools/ralph/dashboard/src/components/story-modal.tsx`
- `tools/ralph/dashboard/src/components/ui/button.tsx`

---

## Feature: Task soft deletes and read tracking

**Time:** 2026-01-28 ~00:20 CR

### What was done

Implemented soft deletes for background tasks with read/unread tracking:

1. **Database migration** - Added `read_at` and `deleted_at` columns to tasks table
2. **Task store refactoring** - Changed from single `pendingTask` to `pendingTasks` array to support multiple concurrent tasks
3. **Task indicator improvements**:
   - Shows only unread tasks in dropdown
   - Cyber-dark badge styling with accent color and hover effects
   - Click navigates to results modal
4. **StoryEditModal** - New modal for story-edit task results following same wizard pattern as Refine/Generate
5. **Navigation fixes** - Tasks now properly navigate and open the correct modal with pre-populated data

### Key patterns

- `pendingTasks` array persisted to localStorage for navigation survival
- Store subscription pattern for detecting pending tasks after page load
- Full page navigation (`window.location.href`) instead of `router.push()` for reliability

### Files created

- `tools/ralph/dashboard/src/lib/db/migrations/004_task_soft_delete.sql`
- `tools/ralph/dashboard/src/lib/task-store.ts`
- `tools/ralph/dashboard/src/app/tasks/page.tsx`
- `tools/ralph/dashboard/src/app/api/tasks/clear/route.ts`
- `docs/knowledge/ralph-dashboard/tasks.md`
- `docs/knowledge/ralph-dashboard/database.md`

### Files modified

- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx` - Added StoryEditModal
- `tools/ralph/dashboard/src/components/stories-header.tsx` - Handle story-edit tasks
- `tools/ralph/dashboard/src/components/task-indicator.tsx` - Navigation + styling
- `tools/ralph/dashboard/src/components/task-provider.tsx` - Use new store
- `tools/ralph/dashboard/src/app/api/tasks/route.ts` - Soft delete support
- `tools/ralph/dashboard/src/app/api/tasks/[id]/route.ts` - Read/delete/restore actions

---
