# Activity Log - 2026-01-24

## Ralph Plan Implementation (Phase 1)

### Editor-Based Feedback Input
- Updated `get-feedback` in `lib/pr.elv` to use editor
- Opens `$EDITOR` / `$VISUAL` / vim with temp file
- Comment lines (starting with #) are ignored
- Empty file cancels feedback

### Story Validation
- Added `validate-story` function in `lib/claude.elv`
- Claude checks if acceptance criteria are clear
- Returns `<valid/>` or `<needs-clarification>` with questions
- Added `--no-validate` flag to skip validation
- Integrated into ralph.elv before Claude execution

### YOLO Mode
- Added `--yolo` flag to `lib/cli.elv`
- Sets: no-validate + auto-pr + auto-merge
- Added warning message on activation

### PR Comment-Based Feedback System
- Added `pr_url` field to `state.json` schema
- Created `post-feedback-comment` function - posts feedback as PR comment
- Created `post-resolution-comment` function - posts changes applied
- Created `get-all-pr-comments` function - reads all comments
- Updated `run-flow` to accept and return `pr_url` state
- PR prompt skipped when `pr_url` already exists in state
- PR description now only updated at merge time (saves tokens)
- Feedback posted as PR comments (visible on GitHub, free)

### Automatic Learning Extraction
- Created `extract-learnings` function in `lib/claude.elv`
- Reads activity log and diff for context
- Asks Claude to identify gotchas, patterns, conventions
- Parses `<learning file="X">` blocks and appends to docs/learnings/
- Created initial learnings structure: gotchas.md, patterns.md, conventions.md
- Integrated into ralph.elv after `<story-complete>`, before PR flow

### Files modified
- `tools/ralph/cli/lib/pr.elv` - Editor feedback, PR comment functions, run-flow changes
- `tools/ralph/cli/lib/claude.elv` - Story validation, learning extraction functions
- `tools/ralph/cli/lib/cli.elv` - --no-validate and --yolo flags
- `tools/ralph/cli/lib/state.elv` - Added pr_url field
- `tools/ralph/cli/ralph.elv` - Validation integration, pr_url handling, learning extraction
- `docs/learnings/gotchas.md` - Created
- `docs/learnings/patterns.md` - Created
- `docs/learnings/conventions.md` - Created

### Desktop Notifications
- Created `notify` function in `lib/ui.elv`
- macOS support via `osascript`
- Linux support via `notify-send`
- Added `--notify` flag
- Triggers on story complete, blocked, all complete

### Skip Story Command
- Added `--skip STORY-ID "reason"` flag
- Created `skip-story` function in `lib/prd.elv`
- Sets skipped=true, passes=true, merged=true (unblocks dependents)
- Logs skip to activity file
- Updated help text

### Configurable Timeouts
- Added `--timeout <seconds>` flag
- Defaults to 1800s (30 min)
- Passed through to Claude invocation

### Auto-archive Activity Logs
- Created `archive-old-logs` function in lib/claude.elv
- Archives logs older than 7 days to logs/activity/archive/YYYY-MM/
- Runs on startup before main loop
- Works on both macOS and Linux

### Retry Clean Slate
- Added `--retry-clean STORY-ID` flag
- Deletes local and remote branch
- Resets story in prd.json (passes=false, merged=false)
- Clears state.json

### Pre-flight Checks
- Created `preflight-checks` function
- Checks: clean git state, GitHub auth, required tools, base branch sync
- Prompts to continue if issues found
- Runs on startup

### Verbose Mode
- Added `--verbose` / `-v` flag to `lib/cli.elv`
- Shows full prompts being sent to Claude
- Shows raw Claude output after execution
- Shows state transitions (in_progress, idle, blocked, feedback loop)
- Updated help text in `lib/ui.elv`

### Status Command
- Added `--status` flag to `lib/cli.elv`
- Created `show-status` function in `lib/prd.elv`
- Displays phase/epic/story hierarchy with progress
- Shows progress percentage (merged/total)
- Shows current story and branch if work in progress
- Legend: [x] merged, [*] passed, [~] skipped, [ ] pending

### Claude Commit Messages
- Created `generate-commit-message` function in `lib/claude.elv`
- Takes story-id and branch-name, returns conventional commit message
- Uses Claude to analyze diff and generate appropriate type/scope/description
- Updated `prompt.md` with detailed conventional commit format instructions
- Includes type (feat/fix/refactor/etc), scope, description, and bullet points

### Plan Mode
- Added `--plan` flag to `lib/cli.elv`
- Created `prepare-plan-prompt` function in `lib/claude.elv`
- Plan prompt includes story details, acceptance criteria, dependencies
- Runs Claude without `--dangerously-skip-permissions` (read-only)
- Outputs implementation plan to stdout without making changes
- Integrated into ralph.elv with early exit after plan generation

### Metrics Tracking
- Created `lib/metrics.elv` module with init, record, show-stats, extract-tokens functions
- Created `metrics.json` structure (totals + per-story breakdown)
- Token extraction from Claude stream-json output
- Records duration, input/output tokens on story complete
- Added `--stats` flag to show metrics summary
- Stats display shows total tokens, duration, averages, recent stories

---

## Ralph Dashboard

### Project Setup
- Created `tools/dashboard/` with Next.js 14 (TypeScript, Tailwind, App Router)
- Initialized shadcn/ui with default config
- Added components: button, card, badge, tabs, table, separator, skeleton
- Lucide icons included

### Data Layer & Layout
- Created `lib/types.ts` with PRD, State, Metrics types
- Created `lib/data.ts` with data fetching functions (getPRD, getState, getMetrics, etc.)
- Built sidebar component with navigation links
- Updated root layout with sidebar + main content area

### Dashboard Home Page
- Created stats cards component (StatsCard)
- Created progress bar component (ProgressBar)
- Created current work component (CurrentWork)
- Built dashboard page with:
  - Stats row (total, merged, tokens, time)
  - Phase progress bars
  - Current work display
- Added 5-second revalidation for auto-refresh

### Stories Pages
- Created StoryCard component with status badges
- Built stories list page with tabs for filtering by status
- Stories grouped by phase within each tab
- Created story detail page with:
  - Header with ID, title, status
  - Intent and acceptance criteria
  - Dependencies and dependents (blocks) sections
  - Metadata (skip reason, merge commit)

### Remaining Pages
- Built metrics page with summary stats and story metrics table
- Built activity page with date tabs showing log content
- Built learnings page with category tabs (gotchas, patterns, conventions)
- All pages have 5-second revalidation for auto-refresh

### ANSI Code Fixes
- Fixed ANSI escape codes leaking into prd.json merge_commit field
- Fixed ANSI codes appearing in PR descriptions
- Root cause: `ui:*` functions output to stdout before redirect
- Solution: Use direct `echo "..." > /dev/tty` in functions that return values via `put`
- Cleaned up merge_commit for STORY-1.1.1

### PR URL Tracking
- Added `pr_url` field to Story interface in types.ts
- Created `set-pr-url` function in `lib/prd.elv`
- Updated `pr.elv` create function to save PR URL to prd.json
- Updated story detail page to display PR link with external link icon
- Added STORY-1.1.1 PR URL: https://github.com/trinity-ai-labs/trinity/pull/16

### Ralph Reorganization
- Moved `scripts/ralph/` to `tools/ralph/cli/`
- Moved `tools/dashboard/` to `tools/ralph/dashboard/`
- Updated all path references across docs and code
- New structure: `tools/ralph/{cli,dashboard}`

### Dependency Graph View
- Added `/graph` page with interactive dependency visualization
- Installed @xyflow/react for graph rendering
- Created StoryNode component with status-colored nodes
- Created useGraphData hook for client-side data fetching
- Added API routes: `/api/prd`, `/api/state`
- Features: click nodes to navigate, minimap, zoom/pan, animated edges for in-progress stories
- Added Graph link to sidebar navigation

### Graph Interaction Improvements
- Separated node click (highlight path) from info icon click (open modal)
- Created StoryModal component for viewing story details
- Added dependency path highlighting in yellow
- Highlighted nodes/edges have higher z-index
- Non-highlighted elements fade out, edges hidden completely

### Dark/Light Theme Support
- Installed next-themes for theme management
- Created ThemeProvider component
- Added settings page at `/settings` with theme toggle
- Theme persists to `settings.json` via `/api/settings`
- Updated StoryNode with theme-aware colors
- Updated graph background, controls, minimap for both themes
- Added CSS overrides for React Flow controls

### Graph Direction Setting
- Added graphDirection setting (horizontal/vertical)
- Updated settings page with direction toggle
- Graph layout adapts: horizontal = left-to-right, vertical = top-to-bottom
- Node handles change position based on direction

### Graph Direction Toggle on Graph Page
- Moved direction toggle from settings page to graph page
- Toggle button in top-right corner with arrow icon
- Clicking toggles between horizontal/vertical layout
- Saves preference to settings.json
- useGraphData hook now accepts direction as parameter

### Vertical Mode Improvements
- Centered rows in vertical mode
- Limited to 6 nodes per row, wraps to additional rows when needed
- Increased spacing between rows (V_GAP: 70) and columns (H_GAP: 80)
- Centered text in node boxes for vertical mode
- Double-click node to open modal (removed info icon)
- Click highlighted node again to deselect
- Added key={direction} to ReactFlow for proper re-centering on toggle

### Stories Page Filters
- Added phase dropdown filter at the top of stories page
- Added epic dropdown filter under each phase header
- Created StoriesList client component for interactive filtering
- Installed shadcn select component
- Filters work together with status tabs

### Graph Auto-Center
- Graph now always centers and fits completely on screen
- Uses ReactFlowProvider and useReactFlow for programmatic fitView
- Re-centers on direction toggle
- Only changes view when user zooms or interacts

### Dashboard Stories Added to Trinity PRD
Added 15 stories for Phase 8: Dashboard (v0.1):

- Epic 1: Dashboard Server (5 stories)
  - Server package, REST API, frontend scaffold, embed, CLI command
- Epic 2: Dashboard UI (7 stories)
  - Home page, stories list, dependency graph, activity, metrics, learnings, themes
- Epic 3: Real-time Features (3 stories)
  - WebSocket server, live Claude output, notifications

### Expanded v0.1 Documentation in ROADMAP.md
- Added full tech stack table: Go/Cobra, SQLite, Next.js 14, Tailwind, shadcn/ui, @xyflow/react, next-themes
- Documented CLI commands and core loop (9 steps)
- Documented dashboard architecture (embedded in Go binary, single port)
- Listed all dashboard pages with features
- Updated decisions table with all tech choices (Cobra, Tailwind, shadcn/ui, @xyflow/react)
- Updated PRD story acceptance criteria with specific tech requirements

### Reorganized Version Numbers
Expanded to five versions with clear progression:
- v1.0 - CLI Core (CLI + Auth)
- v2.0 - Local Dashboard (full control)
- v3.0 - Teams & Cloud (Team DB + Hosted Dashboard read-only)
- v4.0 - Cross-project dependencies
- v5.0 - Wails Desktop GUI

Removed Phase 8 (Dashboard) stories from PRD - those are v2.0, not v1.0.

Total v1.0 stories: 83

### Version Support Added
Added target_version field to stories for release tracking:

**Schema updates (CLAUDE.md):**
- Added target_version field to stories table
- Added versions table for release metadata
- Added version-related DB API methods
- Added version CLI commands

**PRD updates:**
- Added 3 new stories for version support (Epic 1.3)
- Tagged all 86 stories with target_version: "v1.0"

**Ralph updates (lib/prd.elv, lib/cli.elv, ralph.elv, lib/ui.elv):**
- Added get-versions, get-next-story-for-version, version-complete functions
- Added get-version-progress, show-version-status functions
- Added --version-status flag to show version progress
- Added --target-version flag to filter story execution by version
- Updated help text with new flags

Total stories: 86

### Multi-Version PRD Structure
Restructured Ralph to support multiple PRD files per version:

**New structure:**
- `prd/v1.0.json` - v1.0 stories
- `prd/v2.0.json` - v2.0 stories (when ready)

**Ralph changes:**
- Auto-selects lowest incomplete version by default
- `--target-version v1.0` to explicitly target a version
- `--version-status` shows progress for all version files
- Banner shows active version and PRD file
- Allows parallel work (Ralph on v1, human on v2)
- Activity logs now include version (e.g., "## v1.0 - STORY-1.2.3: Title")
- Prompt template updated with {{VERSION}} placeholder
- Plan mode includes version context

**Cross-version dependency syntax:**
```
STORY-1.1.1        -> specific story in current version
1                  -> whole phase 1 in current version
1:2                -> phase 1, epic 2 in current version
v1.0:STORY-1.1.1   -> specific story in v1.0
v1.0:1             -> whole phase 1 in v1.0
v1.0:1:2           -> phase 1, epic 2 in v1.0
v1.0               -> entire v1.0 must be complete
```

---

## Dashboard Improvements (continued)

### Markdown Renderer
- Installed react-markdown and remark-gfm
- Created `components/markdown.tsx` with custom styling for all elements
- Applied to activity and learnings pages
- Fixed code block double-styling (pre handles container, code is minimal inside)

### Graph Page Enhancements
- Added 4 layout options: Horizontal, Horizontal Compact, Vertical, Vertical Compact
- Compact layouts limit to 6 nodes per column/row
- Added TanStack Pacer for debounced layout saves (500ms)
- Added default layout per version (star button to set default)
- Fixed polling race condition using refs to preserve layout state
- Version nodes styled in purple with dark/light mode support
- Nodes locked in auto layouts, draggable only in custom layouts
- Added fullscreen toggle button (uses browser Fullscreen API)
- Fit-to-view available via React Flow controls panel

### Activity Logs Relocation
- Moved activity logs from `docs/activity/` to `logs/activity/`
- Updated all references in Ralph CLI scripts (ralph.elv, lib/claude.elv)
- Updated prompt.md templates
- Updated dashboard data layer
- Updated documentation (learnings, plans, README)

### Archived Logs Support in Dashboard
- Updated getActivityLogs to scan archive/YYYY-MM/ subdirectories
- Added `archived` flag to log entries
- Activity page now has Recent/Archived tabs
- Archived logs show badge indicator
- Counts displayed in header and tab labels

---

## Release Workflow Implementation

### CLI Flags (lib/cli.elv)
- Added `--skip-release` flag to skip release when all stories complete
- Added `--auto-release` flag to auto-release without human approval
- Added `--release-tag <tag>` flag for custom tag name
- Updated `get-config` to include new flags

### Release Module (lib/release.elv)
- Created new module with full release workflow
- `init` - Initialize with project paths and branches
- `get-commit-count` - Count commits between dev and main
- `get-files-stats` - Get diff stats (files changed, insertions/deletions)
- `show-summary` - Display release summary (version, stories, commits, files)
- `prompt-approval` - Human gate with Y/n/e/f options (approve/cancel/edit tag/feedback)
- `run-hotfix` - Run Claude directly for hotfix (not a PRD story)
  - Creates hotfix branch from dev
  - Runs Claude with feedback as prompt
  - Commits and pushes changes
  - Creates PR to dev, merges, cleans up
- `create-release-pr` - Create PR from dev to main
- `merge-release-pr` - Merge the release PR
- `create-tag` - Create annotated tag on main
- `push-tag` - Push tag to remote
- `return-to-dev` - Checkout back to dev
- `run` - Orchestrate full release flow

### PRD Schema Extensions (lib/prd.elv)
- Added `get-story-count` - Count completed stories
- Added `get-stories-summary` - Generate summary for PR body
- Added `mark-version-released` - Update PRD with release info (tag, commit, timestamp)
- Added `is-version-released` - Check if version already released
- Fixed `list-versions` to use `ls | grep` instead of non-existent `path:glob`

### Ralph Integration (ralph.elv)
- Added release module import
- Initialized release module with project paths
- Modified all-stories-complete check to trigger release workflow
- Release flow includes:
  - Summary display
  - Human gate (unless --auto-release)
  - Hotfix loop for feedback
  - Release execution (PR, merge, tag, push)
- Fixed preflight-checks arity issue with `take 1`

### Help Text (lib/ui.elv)
- Added RELEASE OPTIONS section to help text

### Files Modified/Created
- `tools/ralph/cli/lib/cli.elv` - Added release flags
- `tools/ralph/cli/lib/release.elv` - NEW: Complete release module
- `tools/ralph/cli/lib/prd.elv` - Added release functions
- `tools/ralph/cli/ralph.elv` - Integrated release workflow
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `docs/plans/ralph/v1/release-workflow.md` - Plan document
- `docs/plans/ralph/v1/release-workflow-checklist.md` - Implementation checklist

---

## Activity Log Separation

### What was done
- Split activity logs into project-specific folders: `logs/activity/trinity/` and `logs/activity/ralph/`
- Moved existing logs to `logs/activity/ralph/` (they were all Ralph-related)
- Updated dashboard with project selector (Trinity/Ralph toggle)
- Created API route for fetching logs by project
- Updated Ralph CLI scripts to write to the new path

### Files Modified/Created
- `tools/ralph/dashboard/src/lib/data.ts` - Added project parameter to getActivityLogs, added getActivityProjects
- `tools/ralph/dashboard/src/app/activity/page.tsx` - Updated to use client component
- `tools/ralph/dashboard/src/app/activity/activity-client.tsx` - NEW: Client component with project selector
- `tools/ralph/dashboard/src/app/api/activity/route.ts` - NEW: API route for fetching logs
- `tools/ralph/cli/ralph.elv` - Updated activity log path
- `tools/ralph/cli/lib/claude.elv` - Updated activity log paths (archive, get-recent, extract-learnings)
- `tools/ralph/cli/prompt.md` - Updated activity log path references
- `logs/activity/README.md` - NEW: Main README
- `logs/activity/trinity/README.md` - NEW: Trinity logs README
- `logs/activity/ralph/README.md` - Updated for Ralph-specific logs

---

## Dashboard Enhancements (Graph Visualization)

### Bug Fixes
- Fixed layout deletion not falling back to default - `deleteCustomLayout` now sets active to `defaultLayout || 'horizontal'` when deleting active layout
- Fixed double-click not opening modal - Added `zoomOnDoubleClick={false}` to ReactFlow so node double-click handlers work

### Phase/Epic/Version Dependency Support
- Created `resolveDependency()` function in `use-graph-data.tsx`
- Supports dependency syntax:
  - `"1"` → all leaf stories in phase 1
  - `"1:2"` → all leaf stories in phase 1, epic 2
  - `"STORY-1.2.3"` → specific story
  - `"v1.0:..."` → cross-version dependencies (version prefix stripped)
- Updated depth calculation to resolve phase/epic refs to actual story IDs
- Updated edge creation to use resolved dependencies

### Depth-Based Edge Coloring
- Added 13-color rainbow gradient for highlighted dependency paths
- Colors: yellow → orange → red → pink → purple → indigo → blue
- Adaptive color spread:
  - Depth ≤6: uses every other color for more contrast
  - Depth >6: uses all 13 colors
- Version edge always depth 0 (yellow)
- Story edges offset by +1 to avoid double yellow lines

### Dead Ends Toggle
- Added orange footer indicator for leaf nodes (stories nothing depends on)
- Added toggle button in toolbar (second position, before fullscreen)
- Persists setting to `settings.json` via `/api/settings`
- Created `isDeadEnd` and `showDeadEnd` props on story nodes

### Version Node Highlighting
- Version nodes now connect to highlighted dependency paths
- Version edge added to edgeDepths with depth 0
- Always shows yellow line from version to root story when path highlighted

### Files Modified
- `tools/ralph/dashboard/src/hooks/use-graph-data.tsx` - Added `resolveDependency()`, fixed layout deletion, dead-end detection
- `tools/ralph/dashboard/src/app/graph/page.tsx` - Depth colors, dead ends toggle, version connections, zoomOnDoubleClick
- `tools/ralph/dashboard/src/components/story-node.tsx` - Dead end orange footer
- `tools/ralph/dashboard/src/app/api/settings/route.ts` - Added `showDeadEnds` setting

---

## PRD Updates

### STORY-8.1.1 Dependencies
- Changed from 34 individual story deps to `["7", ...]` (phase 7) + 34 dead-end stories
- Phase dependency resolves to all leaf stories in that phase
- Simplified dependency management while keeping explicit dead-end tracking

### Files Modified
- `tools/ralph/cli/prd/v1.0.json` - Updated STORY-8.1.1 depends_on

---

## Documentation Updates

### Trinity v2 Dashboard Roadmap
- Created comprehensive `docs/plans/trinity/v2-dashboard-roadmap.md`
- 57 stories across 3 phases covering full dashboard implementation
- Documents Ralph → Trinity mapping (files vs database)
- Covers: API layer, all dashboard pages, graph features, real-time updates
- Lists all Ralph graph features to port: depth colors, dead-ends, custom layouts, fullscreen

### CLAUDE.md Dependency Syntax
- Added comprehensive dependency syntax documentation
- Covers same-version and cross-version formats
- Examples: phase deps, epic deps, story deps, version-prefixed

### Files Created/Modified
- `docs/plans/trinity/v2-dashboard-roadmap.md` - NEW: Full dashboard roadmap
- `docs/plans/trinity/README.md` - Updated with new docs
- `CLAUDE.md` - Updated dependency syntax docs

---

## Version-Scoped Phases & Branch Naming

### v2 Dashboard Roadmap Reset
- Changed phases from 9-11 to 1-3 (phases are scoped per version)
- Updated all story IDs (e.g., 9.1.1 → 1.1.1, 10.3.1 → 2.3.1, 11.1.1 → 3.1.1)
- Each PRD version now starts fresh at Phase 1

### Branch Naming Convention (CLAUDE.md)
- Added versioned branch naming: `feat/v<VERSION>/story-<PHASE>.<EPIC>.<STORY>`
- Examples: `feat/v1.0/story-1.2.3`, `feat/v2.0/story-2.1.5`
- Updated Branching Strategy section with convention and examples

### Activity Log Documentation (CLAUDE.md)
- Updated "Working on Ralph" section with requirement to update activity logs
- Documented log location: `logs/activity/ralph/YYYY-MM-DD.md`
- Added guidelines for documenting changes

### Files Modified
- `docs/plans/trinity/v2-dashboard-roadmap.md` - Reset phases to 1-3
- `CLAUDE.md` - Added branch naming convention and activity log requirements

---

## Graph Edge Color Refinements

### Edge Deduplication
- Fixed duplicate key error when phase ref and explicit story ref resolve to same story
- Added `edgeIds` Set to track and skip duplicate edges

### Expanded Color Palette (25 colors)
- Increased from 13 to 25 colors for finer gradients
- Adaptive spacing based on max depth:
  - depth ≤6: every 4th color
  - depth 7-12: every 2nd color
  - depth >12: all 25 colors

### Reversed Color Direction
- Colors now flow from selected node backwards to roots
- Selected node's edges = cyan (consistent reference point)
- Root/version edges = yellow (furthest back)
- Easier to understand relationship to selected node

### Files Modified
- `tools/ralph/dashboard/src/hooks/use-graph-data.tsx` - Edge deduplication
- `tools/ralph/dashboard/src/app/graph/page.tsx` - 25 colors, adaptive spacing, reversed direction
