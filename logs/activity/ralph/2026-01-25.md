# Ralph Activity Log - 2026-01-25

## feat/feedback-loops: Add feedback loops to all PR checkpoints

**Started:** 2026-01-25 ~10:00
**Branch:** feat/feedback-loops
**PR:** https://github.com/trinity-ai-labs/trinity/pull/22

### What was done

Added `[f]eedback` option to all three PR checkpoints, allowing users to provide refinement requests that restart the Claude execution loop.

**Three checkpoints now have F option:**
1. Create PR: `[Y]es / [n]o / [f]eedback`
2. Update PR: `[Y]es / [n]o / [f]eedback` (new - shown after feedback loop)
3. Merge: `[y]es merge / [N]o leave open / [f]eedback`

**Key changes:**
- Feedback restarts the loop with user feedback as the prompt
- Created dedicated `prompts/feedback.md` template
- Extracted shared workflow to `prompts/partials/workflow.md`
- Auto-update PR when `--auto-pr` flag set during feedback loop
- Track feedback stage for proper loop routing

### Files modified

- `tools/ralph/cli/lib/pr.elv` - Added F option to Create PR, added Update PR prompt, track stage
- `tools/ralph/cli/lib/claude.elv` - Load feedback template, use it when feedback provided
- `tools/ralph/cli/ralph.elv` - Track was-feedback-refinement, pass to PR flow
- `tools/ralph/cli/prompts/feedback.md` - New feedback template
- `tools/ralph/cli/prompts/partials/workflow.md` - Extracted shared workflow instructions
- `docs/learnings/ralph.md` - Updated feedback loop and PR flow documentation

### Design decisions

1. **Feedback restarts same loop** - Rather than special "feedback mode", feedback just becomes the new prompt and reruns the same execution loop. Same machinery, different input.

2. **Dedicated feedback template** - Instead of just injecting feedback into the main template, created a dedicated template that provides:
   - Original task context (story title + acceptance criteria)
   - User feedback
   - Full workflow instructions (via partial)

3. **Shared workflow partial** - Extracted common workflow instructions (verification, self-review, learnings, commit format) to avoid duplication between story and feedback templates.

4. **Update PR prompt** - When coming back from feedback loop with existing PR, show "Update PR?" before "Merge?". This gives another checkpoint to give feedback or skip update.

5. **Auto-update with --auto-pr** - If user has auto-pr enabled and feedback was given at merge stage, auto-update PR without prompting.

---
