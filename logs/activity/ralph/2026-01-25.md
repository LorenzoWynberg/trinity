# Ralph Activity Log - 2026-01-25

## Prompt optimization: split into lazy-loaded instructions

**Started:** 2026-01-25 ~11:00

### What was done

Split prompt.md into separate instruction files to reduce initial context window usage. Claude now loads instructions per phase instead of all upfront.

**Structure:**
```
tools/ralph/cli/
├── prompt.md              # Lightweight orchestrator
└── instructions/
    ├── context.md         # Doc loading guidance
    ├── activity-log.md    # Activity log template
    ├── implementation.md  # Coding/testing/review
    ├── learnings.md       # Learning loop
    ├── completion.md      # Success/blocked signals
    └── rules.md           # Important rules
```

Also added doc relevance table so Claude only reads docs relevant to the task.

### Files created/modified

- `tools/ralph/cli/prompt.md` - Now just orchestrates, points to instruction files
- `tools/ralph/cli/instructions/*.md` - New instruction files (6 total)

---

## Refactor: Extract functions from ralph.elv to lib modules

**Started:** 2026-01-25 ~10:00

### What was done

Extracted inline code from ralph.elv into appropriate lib modules to improve readability and maintainability. Reduced ralph.elv from 731 lines to 605 lines (~17% reduction).

**Functions extracted:**
- `state:handle-retry-clean` - Reset story for fresh retry (delete branches, reset PRD, clear state)
- `prd:handle-skip` - Skip story with activity logging
- `pr:handle-unmerged` - Handle passed-but-not-merged stories
- `format:go-files` - Format modified Go files with gofmt (new format.elv module)
- `claude:run-plan-mode` - Run plan-only mode for a story

**Note:** Claude streaming pipeline must stay in ralph.elv because Elvish streaming breaks inside functions.

### Files modified

- `tools/ralph/cli/ralph.elv` - Replaced inline code with lib function calls
- `tools/ralph/cli/lib/state.elv` - Added handle-retry-clean, updated init to take project-root
- `tools/ralph/cli/lib/prd.elv` - Added handle-skip
- `tools/ralph/cli/lib/pr.elv` - Added handle-unmerged
- `tools/ralph/cli/lib/format.elv` - New module for code formatting (extensible)
- `tools/ralph/cli/lib/claude.elv` - Added run-plan-mode

---

## feat/feedback-loops: Add feedback loops to all PR checkpoints

**Started:** 2026-01-25 ~04:00
**Branch:** feat/feedback-loops
**PR:** https://github.com/trinity-ai-labs/trinity/pull/22

### What was done

Added `[f]eedback` option to all three PR checkpoints, allowing users to provide refinement requests that restart the Claude execution loop.

**Three checkpoints now have F option:**
1. Create PR: `[Y]es / [n]o / [f]eedback`
2. Update PR: `[Y]es / [n]o / [f]eedback` (new - shown after feedback loop)
3. Merge: `[y]es merge / [N]o leave open / [f]eedback`

**Key changes:**
- Feedback restarts the loop with user feedback as the prompt
- Created dedicated `prompts/feedback.md` template
- Extracted shared workflow to `prompts/partials/workflow.md`
- Auto-update PR when `--auto-pr` flag set during feedback loop
- Track feedback stage for proper loop routing

### Files modified

- `tools/ralph/cli/lib/pr.elv` - Added F option to Create PR, added Update PR prompt, track stage
- `tools/ralph/cli/lib/claude.elv` - Load feedback template, use it when feedback provided
- `tools/ralph/cli/ralph.elv` - Track was-feedback-refinement, pass to PR flow
- `tools/ralph/cli/prompts/feedback.md` - New feedback template
- `tools/ralph/cli/prompts/partials/workflow.md` - Extracted shared workflow instructions
- `docs/learnings/ralph.md` - Updated feedback loop and PR flow documentation

### Design decisions

1. **Feedback restarts same loop** - Rather than special "feedback mode", feedback just becomes the new prompt and reruns the same execution loop. Same machinery, different input.

2. **Dedicated feedback template** - Instead of just injecting feedback into the main template, created a dedicated template that provides:
   - Original task context (story title + acceptance criteria)
   - User feedback
   - Full workflow instructions (via partial)

3. **Shared workflow partial** - Extracted common workflow instructions (verification, self-review, learnings, commit format) to avoid duplication between story and feedback templates.

4. **Update PR prompt** - When coming back from feedback loop with existing PR, show "Update PR?" before "Merge?". This gives another checkpoint to give feedback or skip update.

5. **Auto-update with --auto-pr** - If user has auto-pr enabled and feedback was given at merge stage, auto-update PR without prompting.

---

## Learnings compaction system

**Started:** 2026-01-25 ~09:00

### What was done

Added automatic compaction system for learnings files. Once a month (if file has been updated), Claude will consolidate and clean up the learnings to keep them concise.

**Mechanism:**
- Each learning file has metadata at the bottom: `updatedAt` and `lastCompactedAt`
- At Ralph startup, checks if any file needs compaction (>30 days since last compaction AND updated since)
- If needed, runs Claude to consolidate similar entries, remove redundant info, improve organization
- Aims for ~20-30% reduction while preserving all valuable information

**Integration:**
- `learnings:check-and-compact` called at Ralph startup
- `learnings:mark-updated` called when learnings are written
- Initialized metadata on all existing learning files

**Consolidation:**
- Moved `extract-learnings` function from claude.elv to learnings.elv
- claude.elv now delegates to `learnings:extract`
- All learnings logic now lives in one module

### Files created/modified

- `tools/ralph/cli/lib/learnings.elv` - New module (compaction + extraction)
- `tools/ralph/cli/ralph.elv` - Import learnings module, call check-and-compact
- `tools/ralph/cli/lib/claude.elv` - Delegates to learnings:extract
- `docs/learnings/*.md` - Added metadata to all files

---

## Metrics schema update: track passed, PR'd, and merged separately

**Started:** 2026-01-25 ~08:00

### What was done

Updated metrics tracking to distinguish three stages of story completion:
1. **Passed** - Claude finished the work and pushed
2. **PR'd** - PR created on GitHub
3. **Merged** - PR merged to base branch

**Changes:**
- Updated `metrics.elv` schema: `stories_passed`, `stories_prd`, `stories_merged`
- Added `record-pr` function to track PR creation
- Added `record-merge` function to track PR merge
- Updated `show-stats` to display all three counters
- Updated `pr.elv` to call `metrics:record-pr` after PR creation
- Updated `pr.elv` to call `metrics:record-merge` after successful merge
- Updated dashboard home page to show all three metrics in stats card
- Updated dashboard metrics page with pipeline stats (passed/PR'd/merged) row

### Files modified

- `tools/ralph/cli/lib/metrics.elv` - New schema, record-pr, record-merge functions
- `tools/ralph/cli/lib/pr.elv` - Added metrics tracking calls
- `tools/ralph/cli/metrics.json` - Reset to new schema
- `tools/ralph/dashboard/src/lib/types.ts` - Updated Metrics interface
- `tools/ralph/dashboard/src/app/page.tsx` - Display all three metrics in description
- `tools/ralph/dashboard/src/app/metrics/page.tsx` - Added pipeline stats row, fixed empty check

---

## Blocked state improvements and dashboard updates

**Started:** 2026-01-25 ~03:00

### What was done

**Ralph CLI improvements:**
- Replaced misleading "ALL STORIES COMPLETE" with proper blocked state detection
- Added `prd:show-blocked-state` function showing unmerged PRs and blocked stories
- Added PR skip acknowledgment when user declines to create PR
- Refactored ralph.elv: extracted blocked display and release flow to lib (890 → 726 lines)
- Changed `break` to `exit 0` for clean program exit after blocked/complete states

**Dashboard improvements:**
- Added version dropdown selector to dashboard header
- Added "Blocked" section showing first-gen blocked stories
- Fixed terminology: "completed" → "passed" for clarity
- Fixed story keys to include version to avoid React duplicates
- Added "Story" prefix to story numbers in cards
- Fixed version filtering on Stories page (URL param based)
- Fixed phase count display: shows version count when viewing all versions

### Files modified

**CLI:**
- `tools/ralph/cli/ralph.elv` - Refactored, extracted to lib
- `tools/ralph/cli/lib/prd.elv` - Added show-blocked-state, get-blocked-stories, get-pr-url
- `tools/ralph/cli/lib/pr.elv` - Added PR skip acknowledgment
- `tools/ralph/cli/lib/release.elv` - Added run-full-flow for complete release with prompts

**Dashboard:**
- `tools/ralph/dashboard/src/app/page.tsx` - Version selector, blocked section
- `tools/ralph/dashboard/src/app/stories/page.tsx` - Version filtering via URL params
- `tools/ralph/dashboard/src/components/version-selector.tsx` - New component with Suspense
- `tools/ralph/dashboard/src/components/blocked-stories.tsx` - New component
- `tools/ralph/dashboard/src/components/stories-list.tsx` - URL-based version filter
- `tools/ralph/dashboard/src/components/story-card.tsx` - "Story" prefix
- `tools/ralph/dashboard/src/lib/data.ts` - getBlockedStories, isDepMet fixes
- `tools/ralph/dashboard/src/lib/types.ts` - BlockedInfo type

**Docs:**
- `docs/learnings/ralph.md` - Blocked state, PR skip, dashboard sections
- `docs/learnings/elvish.md` - New file for Elvish-specific gotchas
- `CLAUDE.md` - Updated Ralph working instructions

### Design decisions

1. **First-gen blocked only** - Dashboard shows stories whose blocker is NOT itself blocked. Shows immediate next row, not transitive chains.

2. **Dependency format** - PRD uses short format "1.1.1" not "STORY-1.1.1". Code handles both.

3. **Version scoped phases** - Phases are per-version, so "All versions" shows version count instead of misleading phase count.

4. **Suspense for hydration** - Radix Select + useSearchParams needs Suspense boundary to avoid hydration mismatch.

---

## Improve story validation flow with clarify/auto-proceed options

**Started:** 2026-01-25 ~12:00

### What was done

Enhanced the story validation prompt to allow users to provide clarification or let Claude proceed with reasonable assumptions, instead of only skip/stop.

**New validation prompt:**
```
Story needs clarification:
- Question 1?
- Question 2?

[Y]es skip / [n]o stop / [c]larify / [a]uto-proceed
```

**Options:**
- `[Y]` - Skip story (default, existing behavior)
- `[n]` - Stop execution
- `[c]` - Open editor to provide clarification answers
- `[a]` - Auto-proceed with reasonable assumptions

**New flag: `--auto-clarify`**
Automatically uses auto-proceed on validation questions. For fully autonomous runs.

**PRD improvements:**
Updated stories 1.1.1, 1.1.2, 1.1.3 with more specific acceptance criteria (Go version, module paths, Cobra version, version format).

### Files modified

- `tools/ralph/cli/lib/claude.elv` - validate-story now returns `[&valid &questions]` map; prepare accepts `&clarification` param
- `tools/ralph/cli/lib/prd.elv` - Added `get-clarification` function (opens editor with story questions)
- `tools/ralph/cli/lib/cli.elv` - Added `--auto-clarify` flag
- `tools/ralph/cli/lib/ui.elv` - Added `--auto-clarify` to help text
- `tools/ralph/cli/ralph.elv` - Handle new validation options, pass clarification to claude:prepare
- `tools/ralph/cli/prd/v1.0.json` - Improved stories 1.1.1, 1.1.2, 1.1.3 specifics

### Data flow

```
claude:validate-story() → [&valid=$false &questions="- Q1?\n- Q2?"]
                          ↓
            [c]larify → prd:get-clarification($questions)
                          ↓
                    Editor shows questions, user types answers
                          ↓
                    claude:prepare(..., &clarification=$text)
                          ↓
                    Prompt includes "## User Clarification\n$text"
```

---

## feat: Add external dependencies validation flow

**Started:** 2026-01-25 ~13:30

### What was done

Added external dependencies validation before story execution. Stories can now have `external_deps` field listing third-party systems that must be set up first. User must provide an implementation report (endpoints, auth, schemas, etc.) before Claude proceeds.

**Flow:**
```
Story has external_deps?
  → Show deps list
  → [r]eport / [n]o skip
  → If [r]: open editor with dep descriptions
  → Report injected into prompt: "## External Dependencies Report\n..."
```

**Key design decision:** No "yes ready" option - if a story has external deps, Claude needs to know HOW they were implemented. You either provide the report or skip.

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added `has-external-deps`, `get-external-deps`, `get-external-deps-report` functions
- `tools/ralph/cli/lib/claude.elv` - Added `&external_deps_report` param to `prepare`, injects into prompt
- `tools/ralph/cli/ralph.elv` - Added external deps check before Claude execution
- `docs/learnings/ralph.md` - Added External Dependencies section

---

## feat: External deps report propagation to descendants

**Started:** 2026-01-25 ~14:00

### What was done

When user provides external deps report, Ralph now:
1. Saves report to PRD (`external_deps_report` field)
2. Finds all descendant stories (recursive dependency traversal)
3. Claude analyzes which need acceptance criteria updates
4. Updates only relevant stories with concrete implementation details

**Functions added:**
- `prd:get-descendants` - recursive tree traversal via deps
- `prd:save-external-deps-report` - persist to PRD
- `prd:update-story-acceptance` - modify acceptance criteria
- `prd:get-stories-summary` - format stories for Claude analysis
- `claude:propagate-external-deps` - orchestrates analysis and updates

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 4 new functions for descendants/reports
- `tools/ralph/cli/lib/claude.elv` - Added propagate-external-deps function
- `tools/ralph/cli/ralph.elv` - Call propagation after report received
- `docs/learnings/ralph.md` - Documented propagation flow

---

## feat: Dashboard phase/epic names and collapsible phases

**Started:** 2026-01-25 ~13:00

### What was done

- Added `phases` and `epics` arrays to PRD structure with names
- Updated dashboard to display phase/epic names everywhere
- Made phase sections collapsible with chevron toggle
- Fixed hydration error by wrapping StoriesList in Suspense

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added phases/epics arrays (8 phases, 26 epics)
- `tools/ralph/dashboard/src/lib/types.ts` - Added Phase, Epic types
- `tools/ralph/dashboard/src/lib/data.ts` - Enrich stories with names
- `tools/ralph/dashboard/src/components/stories-list.tsx` - Collapsible phases, names
- `tools/ralph/dashboard/src/components/story-card.tsx` - Show phase/epic names
- `tools/ralph/dashboard/src/app/page.tsx` - Phase names in progress bars

---

## feat: Add Authentication phase to Trinity PRD

**Started:** 2026-01-25 ~15:00

### What was done

Added Phase 7 "Authentication" to Trinity v1.0 PRD with license validation stories. Bumped Polish to Phase 8, Release to Phase 9.

**New Phase 7 stories:**
- 7.1.1 Create auth package structure
- 7.1.2 Implement license key validation (has external_deps for License API)
- 7.1.3 Implement offline validation fallback
- 7.1.4 Implement trinity auth login command
- 7.1.5 Implement trinity auth logout and status commands
- 7.1.6 Integrate license check into run command

**Phase renumbering:**
- Phase 7 (Polish) → Phase 8
- Phase 8 (Release) → Phase 9
- All story IDs updated (7.x.x → 8.x.x, 8.x.x → 9.x.x)
- All dependency references updated

**Totals:** 9 phases, 27 epics, 103 stories

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added auth phase/epic/stories, renumbered existing

---

## feat: Add tags to Trinity PRD stories

**Started:** 2026-01-25 ~15:30

### What was done

Added `tags` field to all 103 stories in the Trinity v1.0 PRD. Tags are automatically assigned based on story content (title, acceptance criteria, phase/epic).

**Tag taxonomy:**

| Category | Tags |
|----------|------|
| Domain | `core`, `cli`, `db`, `git`, `claude`, `prompts`, `auth` |
| Feature | `config`, `prd`, `loop`, `validation`, `recovery`, `release`, `skills` |
| Concern | `api`, `testing`, `ux`, `docs` |

**Tag distribution:**
- `claude` (49), `cli` (27), `db` (24), `prompts` (23)
- `prd` (18), `testing` (18), `git` (16), `validation` (16)
- `loop` (13), `core` (12), `api` (8), `auth` (6)
- `recovery` (4), `release` (4), `config` (3), `skills` (3), `ux` (3), `docs` (2)

### Purpose

Tags will enable:
1. Better duplicate detection when creating stories
2. Smarter propagation (find related stories by tag)
3. Dashboard filtering
4. Cross-cutting concern tracking

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added `tags` field to all stories

---

## feat: Add tag support to story creation and updates

**Started:** 2026-01-25 ~16:00

### What was done

Updated story creation and update functions to support tags throughout the workflow.

**New functions in prd.elv:**
- `update-story-tags` - Update just tags on a story
- `update-story` - Update multiple fields (acceptance, tags, etc.)
- `find-similar-by-tags` - Find stories with overlapping tags (for duplicate detection)

**Updated get-stories-summary:**
- Now includes tags in the output for context

**Updated propagate-external-deps prompt:**
- Added tag taxonomy in prompt
- Schema now includes `tags` field for both updates and creates
- Added duplicate detection rule: "check existing stories with similar tags"

**Updated propagation processing:**
- Updates can now modify tags as well as acceptance
- Creates automatically include tags (defaults to empty array)

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 3 new functions, updated get-stories-summary
- `tools/ralph/cli/lib/claude.elv` - Updated prompt schema and processing for tags

---

## feat: Implement duplicate detection (Feature 1)

**Started:** 2026-01-25 ~17:15

### What was done

Implemented duplicate detection before story creation during propagation. When Claude suggests creating a new story, checks if a similar one already exists.

**Flow:**
1. Get tags from proposed story
2. Find existing stories with ≥1 tag overlap
3. Ask Claude to check semantic similarity (60% threshold)
4. If duplicate found, prompt: `[u]pdate existing / [c]reate new / [s]kip`
5. Handle user choice accordingly

**New functions in claude.elv:**
- `check-for-duplicate` - Asks Claude to check semantic similarity between proposed and existing stories
- `prompt-duplicate-choice` - Prompts user for resolution

**New flag:**
- `--auto-duplicate` - Auto-update existing story when duplicate detected
- Added to `--yolo` mode

### Files modified

- `tools/ralph/cli/lib/cli.elv` - Added `auto-duplicate` flag, updated yolo mode
- `tools/ralph/cli/lib/claude.elv` - Added duplicate check functions, updated init and create loop
- `tools/ralph/cli/ralph.elv` - Pass auto-duplicate to claude:init
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/plans/tag-based-improvements.md` - Marked Feature 1 as implemented

---

## fix: Change --notify to --no-notifs (default on)

**Started:** 2026-01-25 ~17:30

### What was done

Changed notification flag behavior:
- Before: `--notify` enables notifications (default off)
- After: `--no-notifs` disables notifications (default on)

Notifications are now enabled by default since they're helpful for AFK mode.

### Files modified

- `tools/ralph/cli/lib/cli.elv` - Changed default to true, flag to --no-notifs
- `tools/ralph/cli/lib/ui.elv` - Updated help text

---

## feat: Implement reverse dependency check (Feature 2)

**Started:** 2026-01-25 ~17:45

### What was done

After creating a new story during propagation, checks if existing stories should depend on it.

**Flow:**
1. Find stories with ≥1 tag overlap
2. Filter out: own deps, already dependents, would-create-cycle, earlier phases
3. Ask Claude which candidates logically need the new story
4. Show suggestions: `[y]es add all / [n]o skip / [r]eview individually`
5. Apply chosen dependencies

**New functions in prd.elv:**
- `add-dependency` - Add a dep to a story
- `would-create-cycle` - Check if adding dep would create cycle
- `get-dependents` - Get stories that depend on a given story
- `get-story-deps` - Get a story's current dependencies
- `get-story-phase` - Get story's phase number

**New functions in claude.elv:**
- `check-reverse-deps` - Ask Claude to analyze candidates
- `prompt-reverse-deps` - Prompt for all/none/review
- `review-reverse-deps-individually` - Review each suggestion
- `apply-reverse-deps` - Apply chosen dependencies

**New flag:**
- `--auto-reverse-deps` - Auto-add all suggested reverse deps
- Added to `--yolo` mode

**Safety:**
- Rejects backwards phase dependencies (Phase 6 can't depend on Phase 7)
- Double-checks for cycles before each add

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 5 helper functions
- `tools/ralph/cli/lib/cli.elv` - Added flag, updated yolo mode
- `tools/ralph/cli/lib/claude.elv` - Added 4 functions, integrated into create loop
- `tools/ralph/cli/ralph.elv` - Pass flag to claude:init
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/plans/tag-based-improvements.md` - Marked Feature 2 as implemented

---

## feat: Implement smarter propagation - tag-based expansion (Feature 3)

**Started:** 2026-01-25 ~18:15

### What was done

Added Phase B to external deps propagation: after analyzing descendants, finds and analyzes tag-related stories that might also be affected.

**Two-phase analysis:**
- **Phase A (always):** Analyze descendants (direct dependency tree)
- **Phase B (with --include-related):** Analyze tag-related stories not in dependency tree

**Phase B flow:**
1. Find stories with ≥1 tag overlap with source story
2. Exclude source and descendants (already handled in Phase A)
3. Sort by tree proximity (same epic → same phase → adjacent → distant)
4. Analyze with conservative Claude prompt ("might be affected, be conservative")
5. Show separate UI section with results
6. User chooses: `[a]pply all / [r]eview individually / [s]kip all`

**New helper functions in prd.elv:**
- `get-story-epic` - Get story's epic number
- `get-story-tags` - Get story's tags as JSON array
- `sort-by-proximity` - Sort stories by tree proximity to source

**New functions in claude.elv:**
- `analyze-batch` - Analyze a batch of stories with optional context
- `format-decisions-for-context` - Format decisions for context aggregation

**New flags:**
- `--include-related` - Enable Phase B analysis
- `--auto-related` - Auto-apply related updates (implies --include-related)
- Both added to `--yolo` mode

**Conservative prompting:**
Phase B uses a conservative Claude prompt that explicitly says:
- "These stories share tags but do NOT depend on the source story"
- "They MIGHT be affected. Be conservative - only suggest updates if clearly necessary"
- "When in doubt, mark as skip"
- No new story creation in Phase B (only updates)

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 3 helper functions
- `tools/ralph/cli/lib/cli.elv` - Added flags, updated yolo mode and get-config
- `tools/ralph/cli/lib/claude.elv` - Added init params, Phase B logic in propagate-external-deps
- `tools/ralph/cli/ralph.elv` - Pass flags to claude:init
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/plans/tag-based-improvements.md` - Marked Feature 3 as implemented

---

## refactor: Simplify and rename auto flags

**Started:** 2026-01-25 ~19:00

### What was done

Simplified the auto flag system based on review:

**Removed flags:**
- `--no-validate` - Covered by `--auto-clarify` (validation always runs now)
- `--include-related` - Phase B always runs now (no flag needed)

**Renamed flags for clarity:**
- `--auto-duplicate` → `--auto-handle-duplicates`
- `--auto-reverse-deps` → `--auto-add-reverse-deps`
- `--auto-related` → `--auto-update-related`

**Updated `--yolo` mode:**
```
--auto-pr, --auto-merge, --auto-clarify,
--auto-handle-duplicates, --auto-add-reverse-deps, --auto-update-related
```

**Behavior changes:**
- Validation always runs (can't skip) - `--auto-clarify` handles ambiguous stories
- Phase B (tag-related analysis) always runs after Phase A

### Files modified

- `tools/ralph/cli/lib/cli.elv` - Removed flags, renamed variables
- `tools/ralph/cli/lib/claude.elv` - Updated variable names, removed include-related check
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/cli/ralph.elv` - Removed no-validate check, updated claude:init call
- `docs/learnings/ralph.md` - Updated flag names and yolo mode docs
- `docs/plans/ralph/v1/tag-based-improvements.md` - Updated to reflect final implementation

---

## fix: Handle empty stories in metrics display

**Started:** 2026-01-25 ~19:15

### What was done

Fixed arity mismatch error when running `--stats` with no completed stories. The jq command returned empty output causing the assignment to fail.

**Fix:** Wrapped jq call in try/catch with slurp, check for empty before iterating.

### Files modified

- `tools/ralph/cli/lib/metrics.elv` - Handle empty stories array gracefully

---

## feat: Add Ralph tag-based features to Trinity PRD v1.0

**Started:** 2026-01-25 ~19:30

### What was done

Added 3 new stories to Trinity PRD v1.0 to port Ralph's tag-based features:

| Story | Title | Flag |
|-------|-------|------|
| 5.1.10 | Duplicate detection for story creation | `--auto-handle-duplicates` |
| 5.1.11 | Reverse dependency suggestions after story creation | `--auto-add-reverse-deps` |
| 5.1.12 | Tag-based expansion for propagation | `--auto-update-related` |

These features extend the existing 5.1.9 (external deps propagation) with:
- **Duplicate detection**: Check semantic similarity before creating stories
- **Reverse deps**: Suggest which stories should depend on newly created stories
- **Phase B**: Propagate beyond dependency tree to tag-related stories

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added stories 5.1.10, 5.1.11, 5.1.12

---

## refactor: Split PRD into v0.1 and v1.0

**Started:** 2026-01-25 ~19:45

### What was done

Split the large Trinity PRD into two versions for phased delivery:

**v0.1.json** (91 stories) - "It runs stories"
- Phase 1: Foundation
- Phase 2: Database Layer
- Phase 3: Integrations
- Phase 4: Prompts & Schemas
- Phase 5: Core Loop
- Phase 6: CLI Commands

**v1.0.json** (15 stories) - "Production ready"
- Phase 1: Authentication (was Phase 7)
- Phase 2: Polish (was Phase 8)
- Phase 3: Release (was Phase 9)

**Changes made:**
- Story IDs renumbered: 7.x.y→1.x.y, 8.x.y→2.x.y, 9.x.y→3.x.y
- Cross-version dependencies prefixed with `v0.1:` (e.g., `v0.1:6.3.1`)
- All `target_version` fields updated

### Files modified

- `tools/ralph/cli/prd/v0.1.json` - NEW: Core CLI without auth
- `tools/ralph/cli/prd/v1.0.json` - REPLACED: Now just auth/polish/release
- `docs/ROADMAP.md` - Updated version summary to reflect split

---

## feat: Add tag-based feature stories to Trinity PRD

**Started:** 2026-01-25 ~19:30

### What was done

Added 3 new stories to Trinity PRD v1.0 to port Ralph's tag-based features:

| Story | Title | Flag |
|-------|-------|------|
| 5.1.10 | Duplicate detection for story creation | `--auto-handle-duplicates` |
| 5.1.11 | Reverse dependency suggestions | `--auto-add-reverse-deps` |
| 5.1.12 | Tag-based expansion for propagation | `--auto-update-related` |

### Files modified

- `tools/ralph/cli/prd/v0.1.json` - Added stories 5.1.10, 5.1.11, 5.1.12

---

## feat: Dashboard default version setting

**Started:** 2026-01-25 ~19:45

### What was done

Improved version handling in dashboard:

1. **Removed "All versions" option** from version dropdowns on Stories and Dashboard pages
2. **Added "Default Version" setting** in Settings page
3. **Version resolution**: URL param → settings default → first available
4. **Auto-default**: If no setting exists, uses first available version

### Files modified

- `tools/ralph/dashboard/src/app/settings/page.tsx` - Added Default Version setting
- `tools/ralph/dashboard/src/app/stories/page.tsx` - Use settings for default
- `tools/ralph/dashboard/src/app/page.tsx` - Use settings for default
- `tools/ralph/dashboard/src/components/stories-list.tsx` - Removed "All versions"
- `tools/ralph/dashboard/src/components/version-selector.tsx` - Removed "All versions"
- `tools/ralph/dashboard/src/lib/data.ts` - Added getSettings function
- `tools/ralph/dashboard/src/app/api/settings/route.ts` - Added defaultVersion field

---
