# Ralph Activity Log - 2026-01-25

## feat/feedback-loops: Add feedback loops to all PR checkpoints

**Started:** 2026-01-25 ~10:00
**Branch:** feat/feedback-loops
**PR:** https://github.com/trinity-ai-labs/trinity/pull/22

### What was done

Added `[f]eedback` option to all three PR checkpoints, allowing users to provide refinement requests that restart the Claude execution loop.

**Three checkpoints now have F option:**
1. Create PR: `[Y]es / [n]o / [f]eedback`
2. Update PR: `[Y]es / [n]o / [f]eedback` (new - shown after feedback loop)
3. Merge: `[y]es merge / [N]o leave open / [f]eedback`

**Key changes:**
- Feedback restarts the loop with user feedback as the prompt
- Created dedicated `prompts/feedback.md` template
- Extracted shared workflow to `prompts/partials/workflow.md`
- Auto-update PR when `--auto-pr` flag set during feedback loop
- Track feedback stage for proper loop routing

### Files modified

- `tools/ralph/cli/lib/pr.elv` - Added F option to Create PR, added Update PR prompt, track stage
- `tools/ralph/cli/lib/claude.elv` - Load feedback template, use it when feedback provided
- `tools/ralph/cli/ralph.elv` - Track was-feedback-refinement, pass to PR flow
- `tools/ralph/cli/prompts/feedback.md` - New feedback template
- `tools/ralph/cli/prompts/partials/workflow.md` - Extracted shared workflow instructions
- `docs/learnings/ralph.md` - Updated feedback loop and PR flow documentation

### Design decisions

1. **Feedback restarts same loop** - Rather than special "feedback mode", feedback just becomes the new prompt and reruns the same execution loop. Same machinery, different input.

2. **Dedicated feedback template** - Instead of just injecting feedback into the main template, created a dedicated template that provides:
   - Original task context (story title + acceptance criteria)
   - User feedback
   - Full workflow instructions (via partial)

3. **Shared workflow partial** - Extracted common workflow instructions (verification, self-review, learnings, commit format) to avoid duplication between story and feedback templates.

4. **Update PR prompt** - When coming back from feedback loop with existing PR, show "Update PR?" before "Merge?". This gives another checkpoint to give feedback or skip update.

5. **Auto-update with --auto-pr** - If user has auto-pr enabled and feedback was given at merge stage, auto-update PR without prompting.

---

## Metrics schema update: track passed, PR'd, and merged separately

**Started:** 2026-01-25 ~14:00

### What was done

Updated metrics tracking to distinguish three stages of story completion:
1. **Passed** - Claude finished the work and pushed
2. **PR'd** - PR created on GitHub
3. **Merged** - PR merged to base branch

**Changes:**
- Updated `metrics.elv` schema: `stories_passed`, `stories_prd`, `stories_merged`
- Added `record-pr` function to track PR creation
- Added `record-merge` function to track PR merge
- Updated `show-stats` to display all three counters
- Updated `pr.elv` to call `metrics:record-pr` after PR creation
- Updated `pr.elv` to call `metrics:record-merge` after successful merge
- Updated dashboard types and display to show all three metrics

### Files modified

- `tools/ralph/cli/lib/metrics.elv` - New schema, record-pr, record-merge functions
- `tools/ralph/cli/lib/pr.elv` - Added metrics tracking calls
- `tools/ralph/cli/metrics.json` - Reset to new schema
- `tools/ralph/dashboard/src/lib/types.ts` - Updated Metrics interface
- `tools/ralph/dashboard/src/app/page.tsx` - Display all three metrics

---

## Blocked state improvements and dashboard updates

**Started:** 2026-01-25 ~09:00

### What was done

**Ralph CLI improvements:**
- Replaced misleading "ALL STORIES COMPLETE" with proper blocked state detection
- Added `prd:show-blocked-state` function showing unmerged PRs and blocked stories
- Added PR skip acknowledgment when user declines to create PR
- Refactored ralph.elv: extracted blocked display and release flow to lib (890 → 726 lines)
- Changed `break` to `exit 0` for clean program exit after blocked/complete states

**Dashboard improvements:**
- Added version dropdown selector to dashboard header
- Added "Blocked" section showing first-gen blocked stories
- Fixed terminology: "completed" → "passed" for clarity
- Fixed story keys to include version to avoid React duplicates
- Added "Story" prefix to story numbers in cards
- Fixed version filtering on Stories page (URL param based)
- Fixed phase count display: shows version count when viewing all versions

### Files modified

**CLI:**
- `tools/ralph/cli/ralph.elv` - Refactored, extracted to lib
- `tools/ralph/cli/lib/prd.elv` - Added show-blocked-state, get-blocked-stories, get-pr-url
- `tools/ralph/cli/lib/pr.elv` - Added PR skip acknowledgment
- `tools/ralph/cli/lib/release.elv` - Added run-full-flow for complete release with prompts

**Dashboard:**
- `tools/ralph/dashboard/src/app/page.tsx` - Version selector, blocked section
- `tools/ralph/dashboard/src/app/stories/page.tsx` - Version filtering via URL params
- `tools/ralph/dashboard/src/components/version-selector.tsx` - New component with Suspense
- `tools/ralph/dashboard/src/components/blocked-stories.tsx` - New component
- `tools/ralph/dashboard/src/components/stories-list.tsx` - URL-based version filter
- `tools/ralph/dashboard/src/components/story-card.tsx` - "Story" prefix
- `tools/ralph/dashboard/src/lib/data.ts` - getBlockedStories, isDepMet fixes
- `tools/ralph/dashboard/src/lib/types.ts` - BlockedInfo type

**Docs:**
- `docs/learnings/ralph.md` - Blocked state, PR skip, dashboard sections
- `docs/learnings/elvish.md` - New file for Elvish-specific gotchas
- `CLAUDE.md` - Updated Ralph working instructions

### Design decisions

1. **First-gen blocked only** - Dashboard shows stories whose blocker is NOT itself blocked. Shows immediate next row, not transitive chains.

2. **Dependency format** - PRD uses short format "1.1.1" not "STORY-1.1.1". Code handles both.

3. **Version scoped phases** - Phases are per-version, so "All versions" shows version count instead of misleading phase count.

4. **Suspense for hydration** - Radix Select + useSearchParams needs Suspense boundary to avoid hydration mismatch.

---
