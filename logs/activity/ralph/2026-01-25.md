# Ralph Activity Log - 2026-01-25

## Prompt optimization: split into lazy-loaded instructions

**Started:** 2026-01-25 ~17:00

### What was done

Split prompt.md into separate instruction files to reduce initial context window usage. Claude now loads instructions per phase instead of all upfront.

**Structure:**
```
tools/ralph/cli/
├── prompt.md              # Lightweight orchestrator
└── instructions/
    ├── context.md         # Doc loading guidance
    ├── activity-log.md    # Activity log template
    ├── implementation.md  # Coding/testing/review
    ├── learnings.md       # Learning loop
    ├── completion.md      # Success/blocked signals
    └── rules.md           # Important rules
```

Also added doc relevance table so Claude only reads docs relevant to the task.

### Files created/modified

- `tools/ralph/cli/prompt.md` - Now just orchestrates, points to instruction files
- `tools/ralph/cli/instructions/*.md` - New instruction files (6 total)

---

## Refactor: Extract functions from ralph.elv to lib modules

**Started:** 2026-01-25 ~16:00

### What was done

Extracted inline code from ralph.elv into appropriate lib modules to improve readability and maintainability. Reduced ralph.elv from 731 lines to 605 lines (~17% reduction).

**Functions extracted:**
- `state:handle-retry-clean` - Reset story for fresh retry (delete branches, reset PRD, clear state)
- `prd:handle-skip` - Skip story with activity logging
- `pr:handle-unmerged` - Handle passed-but-not-merged stories
- `format:go-files` - Format modified Go files with gofmt (new format.elv module)
- `claude:run-plan-mode` - Run plan-only mode for a story

**Note:** Claude streaming pipeline must stay in ralph.elv because Elvish streaming breaks inside functions.

### Files modified

- `tools/ralph/cli/ralph.elv` - Replaced inline code with lib function calls
- `tools/ralph/cli/lib/state.elv` - Added handle-retry-clean, updated init to take project-root
- `tools/ralph/cli/lib/prd.elv` - Added handle-skip
- `tools/ralph/cli/lib/pr.elv` - Added handle-unmerged
- `tools/ralph/cli/lib/format.elv` - New module for code formatting (extensible)
- `tools/ralph/cli/lib/claude.elv` - Added run-plan-mode

---

## feat/feedback-loops: Add feedback loops to all PR checkpoints

**Started:** 2026-01-25 ~10:00
**Branch:** feat/feedback-loops
**PR:** https://github.com/trinity-ai-labs/trinity/pull/22

### What was done

Added `[f]eedback` option to all three PR checkpoints, allowing users to provide refinement requests that restart the Claude execution loop.

**Three checkpoints now have F option:**
1. Create PR: `[Y]es / [n]o / [f]eedback`
2. Update PR: `[Y]es / [n]o / [f]eedback` (new - shown after feedback loop)
3. Merge: `[y]es merge / [N]o leave open / [f]eedback`

**Key changes:**
- Feedback restarts the loop with user feedback as the prompt
- Created dedicated `prompts/feedback.md` template
- Extracted shared workflow to `prompts/partials/workflow.md`
- Auto-update PR when `--auto-pr` flag set during feedback loop
- Track feedback stage for proper loop routing

### Files modified

- `tools/ralph/cli/lib/pr.elv` - Added F option to Create PR, added Update PR prompt, track stage
- `tools/ralph/cli/lib/claude.elv` - Load feedback template, use it when feedback provided
- `tools/ralph/cli/ralph.elv` - Track was-feedback-refinement, pass to PR flow
- `tools/ralph/cli/prompts/feedback.md` - New feedback template
- `tools/ralph/cli/prompts/partials/workflow.md` - Extracted shared workflow instructions
- `docs/learnings/ralph.md` - Updated feedback loop and PR flow documentation

### Design decisions

1. **Feedback restarts same loop** - Rather than special "feedback mode", feedback just becomes the new prompt and reruns the same execution loop. Same machinery, different input.

2. **Dedicated feedback template** - Instead of just injecting feedback into the main template, created a dedicated template that provides:
   - Original task context (story title + acceptance criteria)
   - User feedback
   - Full workflow instructions (via partial)

3. **Shared workflow partial** - Extracted common workflow instructions (verification, self-review, learnings, commit format) to avoid duplication between story and feedback templates.

4. **Update PR prompt** - When coming back from feedback loop with existing PR, show "Update PR?" before "Merge?". This gives another checkpoint to give feedback or skip update.

5. **Auto-update with --auto-pr** - If user has auto-pr enabled and feedback was given at merge stage, auto-update PR without prompting.

---

## Learnings compaction system

**Started:** 2026-01-25 ~15:00

### What was done

Added automatic compaction system for learnings files. Once a month (if file has been updated), Claude will consolidate and clean up the learnings to keep them concise.

**Mechanism:**
- Each learning file has metadata at the bottom: `updatedAt` and `lastCompactedAt`
- At Ralph startup, checks if any file needs compaction (>30 days since last compaction AND updated since)
- If needed, runs Claude to consolidate similar entries, remove redundant info, improve organization
- Aims for ~20-30% reduction while preserving all valuable information

**Integration:**
- `learnings:check-and-compact` called at Ralph startup
- `learnings:mark-updated` called when learnings are written
- Initialized metadata on all existing learning files

**Consolidation:**
- Moved `extract-learnings` function from claude.elv to learnings.elv
- claude.elv now delegates to `learnings:extract`
- All learnings logic now lives in one module

### Files created/modified

- `tools/ralph/cli/lib/learnings.elv` - New module (compaction + extraction)
- `tools/ralph/cli/ralph.elv` - Import learnings module, call check-and-compact
- `tools/ralph/cli/lib/claude.elv` - Delegates to learnings:extract
- `docs/learnings/*.md` - Added metadata to all files

---

## Metrics schema update: track passed, PR'd, and merged separately

**Started:** 2026-01-25 ~14:00

### What was done

Updated metrics tracking to distinguish three stages of story completion:
1. **Passed** - Claude finished the work and pushed
2. **PR'd** - PR created on GitHub
3. **Merged** - PR merged to base branch

**Changes:**
- Updated `metrics.elv` schema: `stories_passed`, `stories_prd`, `stories_merged`
- Added `record-pr` function to track PR creation
- Added `record-merge` function to track PR merge
- Updated `show-stats` to display all three counters
- Updated `pr.elv` to call `metrics:record-pr` after PR creation
- Updated `pr.elv` to call `metrics:record-merge` after successful merge
- Updated dashboard home page to show all three metrics in stats card
- Updated dashboard metrics page with pipeline stats (passed/PR'd/merged) row

### Files modified

- `tools/ralph/cli/lib/metrics.elv` - New schema, record-pr, record-merge functions
- `tools/ralph/cli/lib/pr.elv` - Added metrics tracking calls
- `tools/ralph/cli/metrics.json` - Reset to new schema
- `tools/ralph/dashboard/src/lib/types.ts` - Updated Metrics interface
- `tools/ralph/dashboard/src/app/page.tsx` - Display all three metrics in description
- `tools/ralph/dashboard/src/app/metrics/page.tsx` - Added pipeline stats row, fixed empty check

---

## Blocked state improvements and dashboard updates

**Started:** 2026-01-25 ~09:00

### What was done

**Ralph CLI improvements:**
- Replaced misleading "ALL STORIES COMPLETE" with proper blocked state detection
- Added `prd:show-blocked-state` function showing unmerged PRs and blocked stories
- Added PR skip acknowledgment when user declines to create PR
- Refactored ralph.elv: extracted blocked display and release flow to lib (890 → 726 lines)
- Changed `break` to `exit 0` for clean program exit after blocked/complete states

**Dashboard improvements:**
- Added version dropdown selector to dashboard header
- Added "Blocked" section showing first-gen blocked stories
- Fixed terminology: "completed" → "passed" for clarity
- Fixed story keys to include version to avoid React duplicates
- Added "Story" prefix to story numbers in cards
- Fixed version filtering on Stories page (URL param based)
- Fixed phase count display: shows version count when viewing all versions

### Files modified

**CLI:**
- `tools/ralph/cli/ralph.elv` - Refactored, extracted to lib
- `tools/ralph/cli/lib/prd.elv` - Added show-blocked-state, get-blocked-stories, get-pr-url
- `tools/ralph/cli/lib/pr.elv` - Added PR skip acknowledgment
- `tools/ralph/cli/lib/release.elv` - Added run-full-flow for complete release with prompts

**Dashboard:**
- `tools/ralph/dashboard/src/app/page.tsx` - Version selector, blocked section
- `tools/ralph/dashboard/src/app/stories/page.tsx` - Version filtering via URL params
- `tools/ralph/dashboard/src/components/version-selector.tsx` - New component with Suspense
- `tools/ralph/dashboard/src/components/blocked-stories.tsx` - New component
- `tools/ralph/dashboard/src/components/stories-list.tsx` - URL-based version filter
- `tools/ralph/dashboard/src/components/story-card.tsx` - "Story" prefix
- `tools/ralph/dashboard/src/lib/data.ts` - getBlockedStories, isDepMet fixes
- `tools/ralph/dashboard/src/lib/types.ts` - BlockedInfo type

**Docs:**
- `docs/learnings/ralph.md` - Blocked state, PR skip, dashboard sections
- `docs/learnings/elvish.md` - New file for Elvish-specific gotchas
- `CLAUDE.md` - Updated Ralph working instructions

### Design decisions

1. **First-gen blocked only** - Dashboard shows stories whose blocker is NOT itself blocked. Shows immediate next row, not transitive chains.

2. **Dependency format** - PRD uses short format "1.1.1" not "STORY-1.1.1". Code handles both.

3. **Version scoped phases** - Phases are per-version, so "All versions" shows version count instead of misleading phase count.

4. **Suspense for hydration** - Radix Select + useSearchParams needs Suspense boundary to avoid hydration mismatch.

---

## Improve story validation flow with clarify/auto-proceed options

**Started:** 2026-01-25 ~18:00

### What was done

Enhanced the story validation prompt to allow users to provide clarification or let Claude proceed with reasonable assumptions, instead of only skip/stop.

**New validation prompt:**
```
Story needs clarification:
- Question 1?
- Question 2?

[Y]es skip / [n]o stop / [c]larify / [a]uto-proceed
```

**Options:**
- `[Y]` - Skip story (default, existing behavior)
- `[n]` - Stop execution
- `[c]` - Open editor to provide clarification answers
- `[a]` - Auto-proceed with reasonable assumptions

**New flag: `--auto-clarify`**
Automatically uses auto-proceed on validation questions. For fully autonomous runs.

**PRD improvements:**
Updated stories 1.1.1, 1.1.2, 1.1.3 with more specific acceptance criteria (Go version, module paths, Cobra version, version format).

### Files modified

- `tools/ralph/cli/lib/claude.elv` - validate-story now returns `[&valid &questions]` map; prepare accepts `&clarification` param
- `tools/ralph/cli/lib/prd.elv` - Added `get-clarification` function (opens editor with story questions)
- `tools/ralph/cli/lib/cli.elv` - Added `--auto-clarify` flag
- `tools/ralph/cli/lib/ui.elv` - Added `--auto-clarify` to help text
- `tools/ralph/cli/ralph.elv` - Handle new validation options, pass clarification to claude:prepare
- `tools/ralph/cli/prd/v1.0.json` - Improved stories 1.1.1, 1.1.2, 1.1.3 specifics

### Data flow

```
claude:validate-story() → [&valid=$false &questions="- Q1?\n- Q2?"]
                          ↓
            [c]larify → prd:get-clarification($questions)
                          ↓
                    Editor shows questions, user types answers
                          ↓
                    claude:prepare(..., &clarification=$text)
                          ↓
                    Prompt includes "## User Clarification\n$text"
```

---

## feat: Add external dependencies validation flow

**Started:** 2026-01-25 ~19:30

### What was done

Added external dependencies validation before story execution. Stories can now have `external_deps` field listing third-party systems that must be set up first. User must provide an implementation report (endpoints, auth, schemas, etc.) before Claude proceeds.

**Flow:**
```
Story has external_deps?
  → Show deps list
  → [r]eport / [n]o skip
  → If [r]: open editor with dep descriptions
  → Report injected into prompt: "## External Dependencies Report\n..."
```

**Key design decision:** No "yes ready" option - if a story has external deps, Claude needs to know HOW they were implemented. You either provide the report or skip.

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added `has-external-deps`, `get-external-deps`, `get-external-deps-report` functions
- `tools/ralph/cli/lib/claude.elv` - Added `&external_deps_report` param to `prepare`, injects into prompt
- `tools/ralph/cli/ralph.elv` - Added external deps check before Claude execution
- `docs/learnings/ralph.md` - Added External Dependencies section

---
