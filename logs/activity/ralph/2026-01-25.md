# Ralph Activity Log - 2026-01-25

## Dashboard: Interactive Terminal Page

**Time:** 2026-01-25 ~19:30 CR

### What was done

Added `/terminal` page to the dashboard with an interactive terminal for running Ralph.

**Features:**
- xterm.js terminal emulator with cyber-dark theme
- WebSocket server (`ws-server.js`) that executes commands
- Quick command buttons: Run, Stop, Status, Stats
- Command reference modal with all Ralph flags (click to copy)
- Auto-starts with `npm run dev` via concurrently

**Technical notes:**
- node-pty had `posix_spawnp failed` errors on Node 22 - used child_process fallback
- Not a full PTY, but command executor sufficient for Ralph usage
- Commands execute in `tools/ralph/cli` directory

### Also fixed

Removed uppercase prompt convention (`[Y/n]`, `[y/N]`) - now all lowercase `[y/n]` across:
- All Ralph CLI code (ralph.elv, lib/*.elv)
- Documentation (learnings, COMMANDS.md, plans)
- PRD acceptance criteria
- Dashboard command reference

### Files created

- `tools/ralph/dashboard/ws-server.js`
- `tools/ralph/dashboard/src/app/terminal/page.tsx`
- `tools/ralph/dashboard/src/components/terminal-view.tsx`
- `tools/ralph/dashboard/src/components/command-reference.tsx`

### Files modified

- `tools/ralph/dashboard/src/components/sidebar.tsx` - Added Terminal nav link
- `tools/ralph/dashboard/package.json` - Added xterm, ws deps + concurrently scripts
- `docs/learnings/ralph.md` - Added Terminal page section
- Multiple files for lowercase prompt convention fix

### Follow-up fixes

- Moved Stop button next to Run (logical grouping)
- Fixed terminal height (was growing infinitely with flex-1, now fixed 500px)
- Fixed page layout to match other pages (p-8 padding)
- Moved Terminal sidebar link under Graph
- Added title, shortTitle, description fields to all PRD version files
- Dashboard header now shows PRD title and description

---

## Prompt optimization: split into lazy-loaded instructions

**Started:** 2026-01-25 ~11:00

### What was done

Split prompt.md into separate instruction files to reduce initial context window usage. Claude now loads instructions per phase instead of all upfront.

**Structure:**
```
tools/ralph/cli/
├── prompt.md              # Lightweight orchestrator
└── instructions/
    ├── context.md         # Doc loading guidance
    ├── activity-log.md    # Activity log template
    ├── implementation.md  # Coding/testing/review
    ├── learnings.md       # Learning loop
    ├── completion.md      # Success/blocked signals
    └── rules.md           # Important rules
```

Also added doc relevance table so Claude only reads docs relevant to the task.

### Files created/modified

- `tools/ralph/cli/prompt.md` - Now just orchestrates, points to instruction files
- `tools/ralph/cli/instructions/*.md` - New instruction files (6 total)

---

## Refactor: Extract functions from ralph.elv to lib modules

**Started:** 2026-01-25 ~10:00

### What was done

Extracted inline code from ralph.elv into appropriate lib modules to improve readability and maintainability. Reduced ralph.elv from 731 lines to 605 lines (~17% reduction).

**Functions extracted:**
- `state:handle-retry-clean` - Reset story for fresh retry (delete branches, reset PRD, clear state)
- `prd:handle-skip` - Skip story with activity logging
- `pr:handle-unmerged` - Handle passed-but-not-merged stories
- `format:go-files` - Format modified Go files with gofmt (new format.elv module)
- `claude:run-plan-mode` - Run plan-only mode for a story

**Note:** Claude streaming pipeline must stay in ralph.elv because Elvish streaming breaks inside functions.

### Files modified

- `tools/ralph/cli/ralph.elv` - Replaced inline code with lib function calls
- `tools/ralph/cli/lib/state.elv` - Added handle-retry-clean, updated init to take project-root
- `tools/ralph/cli/lib/prd.elv` - Added handle-skip
- `tools/ralph/cli/lib/pr.elv` - Added handle-unmerged
- `tools/ralph/cli/lib/format.elv` - New module for code formatting (extensible)
- `tools/ralph/cli/lib/claude.elv` - Added run-plan-mode

---

## feat/feedback-loops: Add feedback loops to all PR checkpoints

**Started:** 2026-01-25 ~04:00
**Branch:** feat/feedback-loops
**PR:** https://github.com/trinity-ai-labs/trinity/pull/22

### What was done

Added `[f]eedback` option to all three PR checkpoints, allowing users to provide refinement requests that restart the Claude execution loop.

**Three checkpoints now have F option:**
1. Create PR: `[Y]es / [n]o / [f]eedback`
2. Update PR: `[Y]es / [n]o / [f]eedback` (new - shown after feedback loop)
3. Merge: `[y]es merge / [N]o leave open / [f]eedback`

**Key changes:**
- Feedback restarts the loop with user feedback as the prompt
- Created dedicated `prompts/feedback.md` template
- Extracted shared workflow to `prompts/partials/workflow.md`
- Auto-update PR when `--auto-pr` flag set during feedback loop
- Track feedback stage for proper loop routing

### Files modified

- `tools/ralph/cli/lib/pr.elv` - Added F option to Create PR, added Update PR prompt, track stage
- `tools/ralph/cli/lib/claude.elv` - Load feedback template, use it when feedback provided
- `tools/ralph/cli/ralph.elv` - Track was-feedback-refinement, pass to PR flow
- `tools/ralph/cli/prompts/feedback.md` - New feedback template
- `tools/ralph/cli/prompts/partials/workflow.md` - Extracted shared workflow instructions
- `docs/learnings/ralph.md` - Updated feedback loop and PR flow documentation

### Design decisions

1. **Feedback restarts same loop** - Rather than special "feedback mode", feedback just becomes the new prompt and reruns the same execution loop. Same machinery, different input.

2. **Dedicated feedback template** - Instead of just injecting feedback into the main template, created a dedicated template that provides:
   - Original task context (story title + acceptance criteria)
   - User feedback
   - Full workflow instructions (via partial)

3. **Shared workflow partial** - Extracted common workflow instructions (verification, self-review, learnings, commit format) to avoid duplication between story and feedback templates.

4. **Update PR prompt** - When coming back from feedback loop with existing PR, show "Update PR?" before "Merge?". This gives another checkpoint to give feedback or skip update.

5. **Auto-update with --auto-pr** - If user has auto-pr enabled and feedback was given at merge stage, auto-update PR without prompting.

---

## Learnings compaction system

**Started:** 2026-01-25 ~09:00

### What was done

Added automatic compaction system for learnings files. Once a month (if file has been updated), Claude will consolidate and clean up the learnings to keep them concise.

**Mechanism:**
- Each learning file has metadata at the bottom: `updatedAt` and `lastCompactedAt`
- At Ralph startup, checks if any file needs compaction (>30 days since last compaction AND updated since)
- If needed, runs Claude to consolidate similar entries, remove redundant info, improve organization
- Aims for ~20-30% reduction while preserving all valuable information

**Integration:**
- `learnings:check-and-compact` called at Ralph startup
- `learnings:mark-updated` called when learnings are written
- Initialized metadata on all existing learning files

**Consolidation:**
- Moved `extract-learnings` function from claude.elv to learnings.elv
- claude.elv now delegates to `learnings:extract`
- All learnings logic now lives in one module

### Files created/modified

- `tools/ralph/cli/lib/learnings.elv` - New module (compaction + extraction)
- `tools/ralph/cli/ralph.elv` - Import learnings module, call check-and-compact
- `tools/ralph/cli/lib/claude.elv` - Delegates to learnings:extract
- `docs/learnings/*.md` - Added metadata to all files

---

## Metrics schema update: track passed, PR'd, and merged separately

**Started:** 2026-01-25 ~08:00

### What was done

Updated metrics tracking to distinguish three stages of story completion:
1. **Passed** - Claude finished the work and pushed
2. **PR'd** - PR created on GitHub
3. **Merged** - PR merged to base branch

**Changes:**
- Updated `metrics.elv` schema: `stories_passed`, `stories_prd`, `stories_merged`
- Added `record-pr` function to track PR creation
- Added `record-merge` function to track PR merge
- Updated `show-stats` to display all three counters
- Updated `pr.elv` to call `metrics:record-pr` after PR creation
- Updated `pr.elv` to call `metrics:record-merge` after successful merge
- Updated dashboard home page to show all three metrics in stats card
- Updated dashboard metrics page with pipeline stats (passed/PR'd/merged) row

### Files modified

- `tools/ralph/cli/lib/metrics.elv` - New schema, record-pr, record-merge functions
- `tools/ralph/cli/lib/pr.elv` - Added metrics tracking calls
- `tools/ralph/cli/metrics.json` - Reset to new schema
- `tools/ralph/dashboard/src/lib/types.ts` - Updated Metrics interface
- `tools/ralph/dashboard/src/app/page.tsx` - Display all three metrics in description
- `tools/ralph/dashboard/src/app/metrics/page.tsx` - Added pipeline stats row, fixed empty check

---

## Blocked state improvements and dashboard updates

**Started:** 2026-01-25 ~03:00

### What was done

**Ralph CLI improvements:**
- Replaced misleading "ALL STORIES COMPLETE" with proper blocked state detection
- Added `prd:show-blocked-state` function showing unmerged PRs and blocked stories
- Added PR skip acknowledgment when user declines to create PR
- Refactored ralph.elv: extracted blocked display and release flow to lib (890 → 726 lines)
- Changed `break` to `exit 0` for clean program exit after blocked/complete states

**Dashboard improvements:**
- Added version dropdown selector to dashboard header
- Added "Blocked" section showing first-gen blocked stories
- Fixed terminology: "completed" → "passed" for clarity
- Fixed story keys to include version to avoid React duplicates
- Added "Story" prefix to story numbers in cards
- Fixed version filtering on Stories page (URL param based)
- Fixed phase count display: shows version count when viewing all versions

### Files modified

**CLI:**
- `tools/ralph/cli/ralph.elv` - Refactored, extracted to lib
- `tools/ralph/cli/lib/prd.elv` - Added show-blocked-state, get-blocked-stories, get-pr-url
- `tools/ralph/cli/lib/pr.elv` - Added PR skip acknowledgment
- `tools/ralph/cli/lib/release.elv` - Added run-full-flow for complete release with prompts

**Dashboard:**
- `tools/ralph/dashboard/src/app/page.tsx` - Version selector, blocked section
- `tools/ralph/dashboard/src/app/stories/page.tsx` - Version filtering via URL params
- `tools/ralph/dashboard/src/components/version-selector.tsx` - New component with Suspense
- `tools/ralph/dashboard/src/components/blocked-stories.tsx` - New component
- `tools/ralph/dashboard/src/components/stories-list.tsx` - URL-based version filter
- `tools/ralph/dashboard/src/components/story-card.tsx` - "Story" prefix
- `tools/ralph/dashboard/src/lib/data.ts` - getBlockedStories, isDepMet fixes
- `tools/ralph/dashboard/src/lib/types.ts` - BlockedInfo type

**Docs:**
- `docs/learnings/ralph.md` - Blocked state, PR skip, dashboard sections
- `docs/learnings/elvish.md` - New file for Elvish-specific gotchas
- `CLAUDE.md` - Updated Ralph working instructions

### Design decisions

1. **First-gen blocked only** - Dashboard shows stories whose blocker is NOT itself blocked. Shows immediate next row, not transitive chains.

2. **Dependency format** - PRD uses short format "1.1.1" not "STORY-1.1.1". Code handles both.

3. **Version scoped phases** - Phases are per-version, so "All versions" shows version count instead of misleading phase count.

4. **Suspense for hydration** - Radix Select + useSearchParams needs Suspense boundary to avoid hydration mismatch.

---

## Improve story validation flow with clarify/auto-proceed options

**Started:** 2026-01-25 ~12:00

### What was done

Enhanced the story validation prompt to allow users to provide clarification or let Claude proceed with reasonable assumptions, instead of only skip/stop.

**New validation prompt:**
```
Story needs clarification:
- Question 1?
- Question 2?

[Y]es skip / [n]o stop / [c]larify / [a]uto-proceed
```

**Options:**
- `[Y]` - Skip story (default, existing behavior)
- `[n]` - Stop execution
- `[c]` - Open editor to provide clarification answers
- `[a]` - Auto-proceed with reasonable assumptions

**New flag: `--auto-clarify`**
Automatically uses auto-proceed on validation questions. For fully autonomous runs.

**PRD improvements:**
Updated stories 1.1.1, 1.1.2, 1.1.3 with more specific acceptance criteria (Go version, module paths, Cobra version, version format).

### Files modified

- `tools/ralph/cli/lib/claude.elv` - validate-story now returns `[&valid &questions]` map; prepare accepts `&clarification` param
- `tools/ralph/cli/lib/prd.elv` - Added `get-clarification` function (opens editor with story questions)
- `tools/ralph/cli/lib/cli.elv` - Added `--auto-clarify` flag
- `tools/ralph/cli/lib/ui.elv` - Added `--auto-clarify` to help text
- `tools/ralph/cli/ralph.elv` - Handle new validation options, pass clarification to claude:prepare
- `tools/ralph/cli/prd/v1.0.json` - Improved stories 1.1.1, 1.1.2, 1.1.3 specifics

### Data flow

```
claude:validate-story() → [&valid=$false &questions="- Q1?\n- Q2?"]
                          ↓
            [c]larify → prd:get-clarification($questions)
                          ↓
                    Editor shows questions, user types answers
                          ↓
                    claude:prepare(..., &clarification=$text)
                          ↓
                    Prompt includes "## User Clarification\n$text"
```

---

## feat: Add external dependencies validation flow

**Started:** 2026-01-25 ~13:30

### What was done

Added external dependencies validation before story execution. Stories can now have `external_deps` field listing third-party systems that must be set up first. User must provide an implementation report (endpoints, auth, schemas, etc.) before Claude proceeds.

**Flow:**
```
Story has external_deps?
  → Show deps list
  → [r]eport / [n]o skip
  → If [r]: open editor with dep descriptions
  → Report injected into prompt: "## External Dependencies Report\n..."
```

**Key design decision:** No "yes ready" option - if a story has external deps, Claude needs to know HOW they were implemented. You either provide the report or skip.

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added `has-external-deps`, `get-external-deps`, `get-external-deps-report` functions
- `tools/ralph/cli/lib/claude.elv` - Added `&external_deps_report` param to `prepare`, injects into prompt
- `tools/ralph/cli/ralph.elv` - Added external deps check before Claude execution
- `docs/learnings/ralph.md` - Added External Dependencies section

---

## feat: External deps report propagation to descendants

**Started:** 2026-01-25 ~14:00

### What was done

When user provides external deps report, Ralph now:
1. Saves report to PRD (`external_deps_report` field)
2. Finds all descendant stories (recursive dependency traversal)
3. Claude analyzes which need acceptance criteria updates
4. Updates only relevant stories with concrete implementation details

**Functions added:**
- `prd:get-descendants` - recursive tree traversal via deps
- `prd:save-external-deps-report` - persist to PRD
- `prd:update-story-acceptance` - modify acceptance criteria
- `prd:get-stories-summary` - format stories for Claude analysis
- `claude:propagate-external-deps` - orchestrates analysis and updates

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 4 new functions for descendants/reports
- `tools/ralph/cli/lib/claude.elv` - Added propagate-external-deps function
- `tools/ralph/cli/ralph.elv` - Call propagation after report received
- `docs/learnings/ralph.md` - Documented propagation flow

---

## feat: Dashboard phase/epic names and collapsible phases

**Started:** 2026-01-25 ~13:00

### What was done

- Added `phases` and `epics` arrays to PRD structure with names
- Updated dashboard to display phase/epic names everywhere
- Made phase sections collapsible with chevron toggle
- Fixed hydration error by wrapping StoriesList in Suspense

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added phases/epics arrays (8 phases, 26 epics)
- `tools/ralph/dashboard/src/lib/types.ts` - Added Phase, Epic types
- `tools/ralph/dashboard/src/lib/data.ts` - Enrich stories with names
- `tools/ralph/dashboard/src/components/stories-list.tsx` - Collapsible phases, names
- `tools/ralph/dashboard/src/components/story-card.tsx` - Show phase/epic names
- `tools/ralph/dashboard/src/app/page.tsx` - Phase names in progress bars

---

## feat: Add Authentication phase to Trinity PRD

**Started:** 2026-01-25 ~15:00

### What was done

Added Phase 7 "Authentication" to Trinity v1.0 PRD with license validation stories. Bumped Polish to Phase 8, Release to Phase 9.

**New Phase 7 stories:**
- 7.1.1 Create auth package structure
- 7.1.2 Implement license key validation (has external_deps for License API)
- 7.1.3 Implement offline validation fallback
- 7.1.4 Implement trinity auth login command
- 7.1.5 Implement trinity auth logout and status commands
- 7.1.6 Integrate license check into run command

**Phase renumbering:**
- Phase 7 (Polish) → Phase 8
- Phase 8 (Release) → Phase 9
- All story IDs updated (7.x.x → 8.x.x, 8.x.x → 9.x.x)
- All dependency references updated

**Totals:** 9 phases, 27 epics, 103 stories

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added auth phase/epic/stories, renumbered existing

---

## feat: Add tags to Trinity PRD stories

**Started:** 2026-01-25 ~15:30

### What was done

Added `tags` field to all 103 stories in the Trinity v1.0 PRD. Tags are automatically assigned based on story content (title, acceptance criteria, phase/epic).

**Tag taxonomy:**

| Category | Tags |
|----------|------|
| Domain | `core`, `cli`, `db`, `git`, `claude`, `prompts`, `auth` |
| Feature | `config`, `prd`, `loop`, `validation`, `recovery`, `release`, `skills` |
| Concern | `api`, `testing`, `ux`, `docs` |

**Tag distribution:**
- `claude` (49), `cli` (27), `db` (24), `prompts` (23)
- `prd` (18), `testing` (18), `git` (16), `validation` (16)
- `loop` (13), `core` (12), `api` (8), `auth` (6)
- `recovery` (4), `release` (4), `config` (3), `skills` (3), `ux` (3), `docs` (2)

### Purpose

Tags will enable:
1. Better duplicate detection when creating stories
2. Smarter propagation (find related stories by tag)
3. Dashboard filtering
4. Cross-cutting concern tracking

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added `tags` field to all stories

---

## feat: Add tag support to story creation and updates

**Started:** 2026-01-25 ~16:00

### What was done

Updated story creation and update functions to support tags throughout the workflow.

**New functions in prd.elv:**
- `update-story-tags` - Update just tags on a story
- `update-story` - Update multiple fields (acceptance, tags, etc.)
- `find-similar-by-tags` - Find stories with overlapping tags (for duplicate detection)

**Updated get-stories-summary:**
- Now includes tags in the output for context

**Updated propagate-external-deps prompt:**
- Added tag taxonomy in prompt
- Schema now includes `tags` field for both updates and creates
- Added duplicate detection rule: "check existing stories with similar tags"

**Updated propagation processing:**
- Updates can now modify tags as well as acceptance
- Creates automatically include tags (defaults to empty array)

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 3 new functions, updated get-stories-summary
- `tools/ralph/cli/lib/claude.elv` - Updated prompt schema and processing for tags

---

## feat: Implement duplicate detection (Feature 1)

**Started:** 2026-01-25 ~17:15

### What was done

Implemented duplicate detection before story creation during propagation. When Claude suggests creating a new story, checks if a similar one already exists.

**Flow:**
1. Get tags from proposed story
2. Find existing stories with ≥1 tag overlap
3. Ask Claude to check semantic similarity (60% threshold)
4. If duplicate found, prompt: `[u]pdate existing / [c]reate new / [s]kip`
5. Handle user choice accordingly

**New functions in claude.elv:**
- `check-for-duplicate` - Asks Claude to check semantic similarity between proposed and existing stories
- `prompt-duplicate-choice` - Prompts user for resolution

**New flag:**
- `--auto-duplicate` - Auto-update existing story when duplicate detected
- Added to `--yolo` mode

### Files modified

- `tools/ralph/cli/lib/cli.elv` - Added `auto-duplicate` flag, updated yolo mode
- `tools/ralph/cli/lib/claude.elv` - Added duplicate check functions, updated init and create loop
- `tools/ralph/cli/ralph.elv` - Pass auto-duplicate to claude:init
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/plans/tag-based-improvements.md` - Marked Feature 1 as implemented

---

## fix: Change --notify to --no-notifs (default on)

**Started:** 2026-01-25 ~17:30

### What was done

Changed notification flag behavior:
- Before: `--notify` enables notifications (default off)
- After: `--no-notifs` disables notifications (default on)

Notifications are now enabled by default since they're helpful for AFK mode.

### Files modified

- `tools/ralph/cli/lib/cli.elv` - Changed default to true, flag to --no-notifs
- `tools/ralph/cli/lib/ui.elv` - Updated help text

---

## feat: Implement reverse dependency check (Feature 2)

**Started:** 2026-01-25 ~17:45

### What was done

After creating a new story during propagation, checks if existing stories should depend on it.

**Flow:**
1. Find stories with ≥1 tag overlap
2. Filter out: own deps, already dependents, would-create-cycle, earlier phases
3. Ask Claude which candidates logically need the new story
4. Show suggestions: `[y]es add all / [n]o skip / [r]eview individually`
5. Apply chosen dependencies

**New functions in prd.elv:**
- `add-dependency` - Add a dep to a story
- `would-create-cycle` - Check if adding dep would create cycle
- `get-dependents` - Get stories that depend on a given story
- `get-story-deps` - Get a story's current dependencies
- `get-story-phase` - Get story's phase number

**New functions in claude.elv:**
- `check-reverse-deps` - Ask Claude to analyze candidates
- `prompt-reverse-deps` - Prompt for all/none/review
- `review-reverse-deps-individually` - Review each suggestion
- `apply-reverse-deps` - Apply chosen dependencies

**New flag:**
- `--auto-reverse-deps` - Auto-add all suggested reverse deps
- Added to `--yolo` mode

**Safety:**
- Rejects backwards phase dependencies (Phase 6 can't depend on Phase 7)
- Double-checks for cycles before each add

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 5 helper functions
- `tools/ralph/cli/lib/cli.elv` - Added flag, updated yolo mode
- `tools/ralph/cli/lib/claude.elv` - Added 4 functions, integrated into create loop
- `tools/ralph/cli/ralph.elv` - Pass flag to claude:init
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/plans/tag-based-improvements.md` - Marked Feature 2 as implemented

---

## feat: Implement smarter propagation - tag-based expansion (Feature 3)

**Started:** 2026-01-25 ~18:15

### What was done

Added Phase B to external deps propagation: after analyzing descendants, finds and analyzes tag-related stories that might also be affected.

**Two-phase analysis:**
- **Phase A (always):** Analyze descendants (direct dependency tree)
- **Phase B (with --include-related):** Analyze tag-related stories not in dependency tree

**Phase B flow:**
1. Find stories with ≥1 tag overlap with source story
2. Exclude source and descendants (already handled in Phase A)
3. Sort by tree proximity (same epic → same phase → adjacent → distant)
4. Analyze with conservative Claude prompt ("might be affected, be conservative")
5. Show separate UI section with results
6. User chooses: `[a]pply all / [r]eview individually / [s]kip all`

**New helper functions in prd.elv:**
- `get-story-epic` - Get story's epic number
- `get-story-tags` - Get story's tags as JSON array
- `sort-by-proximity` - Sort stories by tree proximity to source

**New functions in claude.elv:**
- `analyze-batch` - Analyze a batch of stories with optional context
- `format-decisions-for-context` - Format decisions for context aggregation

**New flags:**
- `--include-related` - Enable Phase B analysis
- `--auto-related` - Auto-apply related updates (implies --include-related)
- Both added to `--yolo` mode

**Conservative prompting:**
Phase B uses a conservative Claude prompt that explicitly says:
- "These stories share tags but do NOT depend on the source story"
- "They MIGHT be affected. Be conservative - only suggest updates if clearly necessary"
- "When in doubt, mark as skip"
- No new story creation in Phase B (only updates)

### Files modified

- `tools/ralph/cli/lib/prd.elv` - Added 3 helper functions
- `tools/ralph/cli/lib/cli.elv` - Added flags, updated yolo mode and get-config
- `tools/ralph/cli/lib/claude.elv` - Added init params, Phase B logic in propagate-external-deps
- `tools/ralph/cli/ralph.elv` - Pass flags to claude:init
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/plans/tag-based-improvements.md` - Marked Feature 3 as implemented

---

## refactor: Simplify and rename auto flags

**Started:** 2026-01-25 ~19:00

### What was done

Simplified the auto flag system based on review:

**Removed flags:**
- `--no-validate` - Covered by `--auto-clarify` (validation always runs now)
- `--include-related` - Phase B always runs now (no flag needed)

**Renamed flags for clarity:**
- `--auto-duplicate` → `--auto-handle-duplicates`
- `--auto-reverse-deps` → `--auto-add-reverse-deps`
- `--auto-related` → `--auto-update-related`

**Updated `--yolo` mode:**
```
--auto-pr, --auto-merge, --auto-clarify,
--auto-handle-duplicates, --auto-add-reverse-deps, --auto-update-related
```

**Behavior changes:**
- Validation always runs (can't skip) - `--auto-clarify` handles ambiguous stories
- Phase B (tag-related analysis) always runs after Phase A

### Files modified

- `tools/ralph/cli/lib/cli.elv` - Removed flags, renamed variables
- `tools/ralph/cli/lib/claude.elv` - Updated variable names, removed include-related check
- `tools/ralph/cli/lib/ui.elv` - Updated help text
- `tools/ralph/cli/ralph.elv` - Removed no-validate check, updated claude:init call
- `docs/learnings/ralph.md` - Updated flag names and yolo mode docs
- `docs/plans/ralph/v1/tag-based-improvements.md` - Updated to reflect final implementation

---

## fix: Handle empty stories in metrics display

**Started:** 2026-01-25 ~19:15

### What was done

Fixed arity mismatch error when running `--stats` with no completed stories. The jq command returned empty output causing the assignment to fail.

**Fix:** Wrapped jq call in try/catch with slurp, check for empty before iterating.

### Files modified

- `tools/ralph/cli/lib/metrics.elv` - Handle empty stories array gracefully

---

## feat: Add Ralph tag-based features to Trinity PRD v1.0

**Started:** 2026-01-25 ~19:30

### What was done

Added 3 new stories to Trinity PRD v1.0 to port Ralph's tag-based features:

| Story | Title | Flag |
|-------|-------|------|
| 5.1.10 | Duplicate detection for story creation | `--auto-handle-duplicates` |
| 5.1.11 | Reverse dependency suggestions after story creation | `--auto-add-reverse-deps` |
| 5.1.12 | Tag-based expansion for propagation | `--auto-update-related` |

These features extend the existing 5.1.9 (external deps propagation) with:
- **Duplicate detection**: Check semantic similarity before creating stories
- **Reverse deps**: Suggest which stories should depend on newly created stories
- **Phase B**: Propagate beyond dependency tree to tag-related stories

### Files modified

- `tools/ralph/cli/prd/v1.0.json` - Added stories 5.1.10, 5.1.11, 5.1.12

---

## refactor: Split PRD into v0.1 and v1.0

**Started:** 2026-01-25 ~19:45

### What was done

Split the large Trinity PRD into two versions for phased delivery:

**v0.1.json** (91 stories) - "It runs stories"
- Phase 1: Foundation
- Phase 2: Database Layer
- Phase 3: Integrations
- Phase 4: Prompts & Schemas
- Phase 5: Core Loop
- Phase 6: CLI Commands

**v1.0.json** (15 stories) - "Production ready"
- Phase 1: Authentication (was Phase 7)
- Phase 2: Polish (was Phase 8)
- Phase 3: Release (was Phase 9)

**Changes made:**
- Story IDs renumbered: 7.x.y→1.x.y, 8.x.y→2.x.y, 9.x.y→3.x.y
- Cross-version dependencies prefixed with `v0.1:` (e.g., `v0.1:6.3.1`)
- All `target_version` fields updated

### Files modified

- `tools/ralph/cli/prd/v0.1.json` - NEW: Core CLI without auth
- `tools/ralph/cli/prd/v1.0.json` - REPLACED: Now just auth/polish/release
- `docs/ROADMAP.md` - Updated version summary to reflect split

---

## feat: Add tag-based feature stories to Trinity PRD

**Started:** 2026-01-25 ~19:30

### What was done

Added 3 new stories to Trinity PRD v1.0 to port Ralph's tag-based features:

| Story | Title | Flag |
|-------|-------|------|
| 5.1.10 | Duplicate detection for story creation | `--auto-handle-duplicates` |
| 5.1.11 | Reverse dependency suggestions | `--auto-add-reverse-deps` |
| 5.1.12 | Tag-based expansion for propagation | `--auto-update-related` |

### Files modified

- `tools/ralph/cli/prd/v0.1.json` - Added stories 5.1.10, 5.1.11, 5.1.12

---

## feat: Dashboard default version setting

**Started:** 2026-01-25 ~19:45

### What was done

Improved version handling in dashboard:

1. **Removed "All versions" option** from version dropdowns on Stories and Dashboard pages
2. **Added "Default Version" setting** in Settings page
3. **Version resolution**: URL param → settings default → first available
4. **Auto-default**: If no setting exists, uses first available version

### Files modified

- `tools/ralph/dashboard/src/app/settings/page.tsx` - Added Default Version setting
- `tools/ralph/dashboard/src/app/stories/page.tsx` - Use settings for default
- `tools/ralph/dashboard/src/app/page.tsx` - Use settings for default
- `tools/ralph/dashboard/src/components/stories-list.tsx` - Removed "All versions"
- `tools/ralph/dashboard/src/components/version-selector.tsx` - Removed "All versions"
- `tools/ralph/dashboard/src/lib/data.ts` - Added getSettings function
- `tools/ralph/dashboard/src/app/api/settings/route.ts` - Added defaultVersion field

---

## fix: Cross-version dependency parsing & PRD ordering

**Started:** 2026-01-25 ~20:00

### What was done

1. **Fixed cross-version dependency parsing bug** in graph visualization
   - `split(':')` on `v0.1:1.1.1` incorrectly gave `["v0", "1", "1.1.1"]`
   - Fixed using `indexOf(':')` and `slice()` to get `["v0.1", "1.1.1"]`

2. **Fixed v1.0 PRD story ordering**
   - Stories were out of order (Phase 2 before Phase 1)
   - Sorted by phase, epic, story_number

3. **Added missing dependencies in v1.0**
   - Phase 2 (Polish) stories now depend on Phase 1 (Auth) completion
   - Added `1.1.6` as dependency to 2.1.1, 2.1.2, 2.2.1, 2.2.2

### Files modified

- `tools/ralph/dashboard/src/hooks/use-graph-data.tsx` - Fixed cross-version dep parsing
- `tools/ralph/cli/prd/v1.0.json` - Fixed ordering, added Auth→Polish dependencies

---

## feat: External deps toggle in graph

**Started:** 2026-01-25 ~20:30

### What was done

Added button to hide/show cross-version dependency lines in graph:

1. **"External" toggle button** in graph toolbar (next to "Dead ends")
   - OFF by default - cross-version edges hidden
   - When ON, shows orange dashed lines for cross-version deps
   - Setting persists via `/api/settings`

2. **Loading state for view deletion**
   - Layout dropdown shows spinner when deleting a custom view

3. **Reset showDeadEnds default to false** in settings.json

### Files modified

- `tools/ralph/dashboard/src/hooks/use-graph-data.tsx` - Added `data.crossVersion` flag to edges
- `tools/ralph/dashboard/src/app/graph/page.tsx` - Added toggle button, filtering, delete loading state
- `tools/ralph/dashboard/settings.json` - Reset showDeadEnds to false

---

## feat: Add PRD refinement and story generation commands

**Started:** 2026-01-25 ~21:00

### What was done

Added two new Ralph commands for PRD management via Claude:

**`--refine-prd [story-id]`** - Review stories and suggest improvements
- Reviews acceptance criteria for vagueness
- Suggests clearer, more specific criteria
- Can suggest splitting large stories
- Optionally applies suggested refinements to PRD

**`--add-stories "description"`** - Generate new stories from description
- Takes a natural language description
- Generates properly formatted stories with acceptance criteria
- Fits into existing phases/epics structure
- Avoids duplicating existing stories
- Optionally adds generated stories to PRD

### Prompts

Both use the same pattern as `validate-story`:
- Send context + prompt to Claude
- Parse JSON response
- Offer to apply changes interactively

### Version awareness

Both commands respect `--target-version` flag:
```bash
./ralph.elv --refine-prd --target-version v0.1
./ralph.elv --add-stories "Add OAuth" --target-version v1.0
```

### PRD sorting

Added `prd:sort-stories` function that sorts by phase, epic, story_number.
Called automatically after:
- `prd:create-story`
- Applying refinements

### Files modified

- `tools/ralph/cli/lib/cli.elv` - Added flags: `--refine-prd`, `--add-stories`
- `tools/ralph/cli/lib/claude.elv` - Added functions: `refine-prd`, `add-stories-from-description`
- `tools/ralph/cli/lib/prd.elv` - Added `sort-stories` function, call from `create-story`
- `tools/ralph/cli/lib/ui.elv` - Updated help text with new commands
- `tools/ralph/cli/ralph.elv` - Added mode handling for new commands
- `tools/ralph/cli/README.md` - Added PRD Management section

---

## feat: Dashboard PRD Tools page

**Started:** 2026-01-25 ~21:30

### What was done

Added a new "PRD Tools" page to the dashboard with Claude-powered features:

**Refine Stories**
- Analyzes pending stories in selected version
- Shows issues and suggested acceptance criteria
- Click to select/deselect refinements
- Apply selected refinements to PRD

**Generate Stories**
- Enter a natural language description
- Claude generates properly formatted stories
- Shows phase, epic, tags, acceptance criteria
- Click to select/deselect stories
- Add selected stories to PRD

### API Endpoints

- `POST /api/prd/refine` - Get refinement suggestions from Claude
- `PUT /api/prd/refine` - Apply selected refinements
- `POST /api/prd/generate` - Generate stories from description
- `PUT /api/prd/generate` - Add generated stories to PRD

### Files created

- `tools/ralph/dashboard/src/app/prd-tools/page.tsx` - PRD Tools page
- `tools/ralph/dashboard/src/app/api/prd/refine/route.ts` - Refine API
- `tools/ralph/dashboard/src/app/api/prd/generate/route.ts` - Generate API
- `tools/ralph/dashboard/src/components/ui/textarea.tsx` - Textarea component

### Files modified

- `tools/ralph/dashboard/src/components/sidebar.tsx` - Added PRD Tools nav link

---

## feat: Wizard-style PRD modals on Stories page

**Started:** 2026-01-25 ~22:00

### What was done

Moved Refine/Generate PRD tools from dedicated page to modals on the Stories page, and added story editing capability with related story checking.

**Stories page improvements:**
- Added "Refine" and "Generate" buttons in header (top right)
- Buttons open wizard-style modals with step indicators

**Wizard modals (RefineStoriesModal, GenerateStoriesModal):**
- 3-step flow: Analyze/Input → Review → Complete
- Step indicator showing progress (checkmarks for completed steps)
- Select/deselect individual items to apply
- Loading states with spinners
- Error handling with alerts

**Story modal edit functionality:**
- Added pencil icon to edit story acceptance criteria
- 3-step wizard: Input → Review → Complete
- Input step: textarea for requested changes
- Analyze step: sends to Claude, finds related stories with overlapping tags
- Review step: shows main story updates + related story updates (amber bg)
  - Click cards to select/deselect
  - Shows checkbox state on each card
- Apply selected updates to PRD
- Complete step: shows success with count

**API endpoint:**
- `POST /api/prd/story` - Analyze requested changes, find related stories
- `PUT /api/prd/story` - Apply story updates to PRD

### Files created

- `tools/ralph/dashboard/src/app/api/prd/story/route.ts` - Story edit API
- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx` - Wizard modals
- `tools/ralph/dashboard/src/components/stories-header.tsx` - Header with modal buttons

### Files modified

- `tools/ralph/dashboard/src/app/stories/page.tsx` - Use StoriesHeader
- `tools/ralph/dashboard/src/components/story-modal.tsx` - Added edit wizard

---

## feat: Add inline editing to all PRD wizard flows

**Started:** 2026-01-25 ~22:30

### What was done

Added the ability to edit Claude's suggestions before applying them in all three PRD wizard flows.

**Common pattern:**
- Each card in the review step now has a pencil icon
- Click pencil to expand card into edit mode
- Edit the acceptance criteria (one per line)
- Click checkmark to save, X to cancel
- Card stays selected/deselected state through edit

**1. Refine Stories Modal:**
- Edit suggested acceptance criteria before applying refinement

**2. Generate Stories Modal:**
- Edit title, phase, epic, tags, intent, and acceptance criteria
- All fields are editable in a compact form

**3. Story Edit Modal:**
- Edit main story's updated acceptance criteria
- Edit each related story's suggested acceptance criteria

### Files modified

- `tools/ralph/dashboard/src/components/prd-tools-modals.tsx` - Added edit state and handlers for both modals
- `tools/ralph/dashboard/src/components/story-modal.tsx` - Added edit state and handlers for review cards

---

## fix: Add missing shadcn Input component

**Started:** 2026-01-25 ~22:45

### What was done

Added the Input component via shadcn CLI. Was missing when the inline editing feature tried to import it.

```bash
npx shadcn@latest add input --overwrite
```

### Files created

- `tools/ralph/dashboard/src/components/ui/input.tsx` - shadcn Input component

---

## feat: Add cyberpunk theme option

**Started:** 2026-01-25 ~23:00

### What was done

Added a third theme option with a cyberpunk aesthetic (magenta/cyan neon on dark purple).

**Colors:**
- Background: Deep purple-black (`oklch(0.1 0.02 280)`)
- Foreground: Cyan (`oklch(0.95 0.15 180)`)
- Primary: Hot pink/magenta (`oklch(0.75 0.25 330)`)
- Accent: Cyan (`oklch(0.6 0.25 180)`)
- Borders: Pink glow (`oklch(0.75 0.25 330 / 30%)`)

### Files modified

- `tools/ralph/dashboard/src/app/globals.css` - Added `.cyberpunk` theme variables and React Flow styles
- `tools/ralph/dashboard/src/app/settings/page.tsx` - Added Cyber theme button with Zap icon
- `tools/ralph/dashboard/src/app/layout.tsx` - Added cyberpunk to themes array

---

## feat: Split cyberpunk into cyber-light and cyber-dark

**Started:** 2026-01-25 ~23:15

### What was done

Split the single cyberpunk theme into two variants that respect light/dark mode:

- **cyber-dark**: Original neon-on-purple-black theme
- **cyber-light**: Pink/cyan accents on light lavender background

Also updated graph page to recognize `cyber-dark` as a dark theme for proper contrast.

### Files modified

- `tools/ralph/dashboard/src/app/globals.css` - Split `.cyberpunk` into `.cyber-dark` and `.cyber-light`
- `tools/ralph/dashboard/src/app/settings/page.tsx` - Show both Cyber Light and Cyber Dark options
- `tools/ralph/dashboard/src/app/layout.tsx` - Updated themes array
- `tools/ralph/dashboard/src/app/graph/page.tsx` - Recognize cyber-dark as dark theme

---

## refactor: Remove standalone PRD Tools page

**Started:** 2026-01-25 ~23:30

### What was done

Removed the standalone `/prd-tools` page since that functionality has been moved to:
- **Stories page header**: Refine and Generate buttons open wizard modals
- **Story modal**: Edit button opens inline edit wizard

### Files removed

- `tools/ralph/dashboard/src/app/prd-tools/page.tsx` - Standalone page (replaced by modals)

### Files modified

- `tools/ralph/dashboard/src/components/sidebar.tsx` - Removed PRD Tools nav link

---

## feat: Add Edit Story button to story detail page

**Started:** 2026-01-25 ~23:45

### What was done

Added "Edit Story" button to the individual story detail page (`/stories/[id]`). Opens the same wizard modal as the story card's pencil icon.

### Files created

- `tools/ralph/dashboard/src/components/story-edit-button.tsx` - Client component wrapper for edit button + modal

### Files modified

- `tools/ralph/dashboard/src/app/stories/[id]/page.tsx` - Added StoryEditButton to header, fetch version info

---

## fix: Improve cyber theme graph and edit button UX

**Started:** 2026-01-25 ~24:00

### What was done

1. **Cyber theme graph colors** - Graph now uses proper cyberpunk colors:
   - Background: Purple-black (dark) / Lavender (light)
   - Dots: Pink glow
   - Minimap: Matching theme colors
   - Story nodes: Cyber-themed borders and backgrounds

2. **Edit button goes to wizard** - "Edit Story" button on story detail page now opens directly to the edit wizard (input step) instead of showing the story modal view first.

### Files modified

- `tools/ralph/dashboard/src/app/graph/page.tsx` - Added `isCyber` detection, themed colors
- `tools/ralph/dashboard/src/components/story-node.tsx` - Added cyber-dark/cyber-light status colors
- `tools/ralph/dashboard/src/components/story-modal.tsx` - Added `startInEditMode` prop
- `tools/ralph/dashboard/src/components/story-edit-button.tsx` - Uses `startInEditMode` prop

---

## feat: Update cyber-dark theme graph colors

**Started:** 2026-01-25 ~24:30

### What was done

Updated graph node colors for cyber-dark theme to be more vibrant and readable:

**Story nodes:**
- Background: Cyan with slight transparency (`bg-cyan-900/80`, `bg-cyan-800/90`, etc.)
- Borders: Cyan (base) with status-specific highlights (yellow for passed, green for merged, etc.)
- Text: Purple (`text-purple-200` for label, `text-purple-300` for title)
- Status dots: Purple for pending/in_progress, yellow/green/red for other states

**Version nodes:**
- Background: Yellow with transparency (`bg-yellow-900/80`)
- Border: Yellow (`border-yellow-400`)
- Text: Cyan (`text-cyan-300` for label, `text-cyan-400` for count)
- Progress bar background: Dark yellow (`bg-yellow-950`)

### Files modified

- `tools/ralph/dashboard/src/components/story-node.tsx` - Cyan backgrounds, purple text for cyber-dark
- `tools/ralph/dashboard/src/components/version-node.tsx` - Yellow background, cyan text for cyber-dark

---
