# Ralph Activity Log - 2026-01-30

## Feature: Autopilot auto-continue with graceful stop

**Time:** 2026-01-30 ~21:00 SAST

### What was done

Completed the autopilot mode implementation in the Run Modal with auto-continue behavior and graceful stop option.

### Changes

1. **Auto-continue in autopilot mode** - When a story completes in autopilot mode, automatically starts the next story instead of showing the Done step

2. **Graceful stop option** - Added "Stop after this story" button in the Execute step during autopilot:
   - Shows yellow confirmation banner when clicked
   - Cancel button to resume autopilot
   - When story completes with stop requested, shows Done step with "Autopilot stopped as requested" message

3. **Execution logs persist** - Log history is preserved across stories in autopilot mode so you can see the full run history

### Files modified

- `tools/ralph/dashboard/src/components/run-modal.tsx` - Added auto-continue logic in `handleRunResponse` and stopAfterCurrent state
- `docs/knowledge/ralph-dashboard/execution.md` - Updated documentation with autopilot behavior

---

## Refactor: Remove Ralph CLI

**Time:** 2026-01-30 ~21:20 SAST

### What was done

Removed the Elvish CLI implementation. Ralph is now dashboard-only.

### Removed

- `tools/ralph/cli/ralph.elv` - Main CLI script (42KB)
- `tools/ralph/cli/lib/` - All Elvish libraries (11 files, ~188KB)
- `tools/ralph/cli/instructions/` - CLI instruction files
- `tools/ralph/cli/prompts/` - CLI prompts
- `docs/knowledge/ralph-cli/` - CLI documentation (16 files)

### Kept (dashboard dependencies)

- `tools/ralph/cli/prd/` - PRD JSON files
- `tools/ralph/cli/prompt.md` - Execution prompt template
- `tools/ralph/cli/state.json` - Execution state
- `tools/ralph/cli/metrics.json` - Metrics data

### Files modified

- `CLAUDE.md` - Updated with dashboard-focused instructions, removed CLI references

---

## Refactor: Migrate PRD and state to SQLite

**Time:** 2026-01-30 ~22:00 SAST

### What was done

Migrated all PRD data, run state, and metrics from JSON files to SQLite. Consolidated schema for cleaner data model.

### Schema

```
versions          - Version metadata (v0.1, v1.0, etc.)
phases            - Phases per version
epics             - Epics per version

stories           - Story definitions + status
  ├── target_branch    (default: 'dev')
  ├── working_branch   (feature branch)
  ├── passes/merged/skipped
  └── pr_url, merge_commit

run_state         - Current execution (single row)
  ├── current_story
  ├── status (idle/running/paused/waiting_gate/blocked)
  └── attempts, last_completed, last_error

execution_log     - History of all Claude runs (metrics derived from this)
  ├── story_id, attempt
  ├── started_at, finished_at, duration_seconds
  ├── input_tokens, output_tokens
  └── status, error_message

checkpoints       - Resume capability mid-execution
```

### Key changes

1. **PRD data in SQLite** - Stories now have versioned IDs (`v0.1:1.1.1`) to be unique across versions
2. **Separate branch fields** - `target_branch` (where to merge) and `working_branch` (feature branch)
3. **execution_log replaces story_metrics** - Full history of runs, metrics computed from log
4. **Simplified run_state** - Git details moved to story, run_state just tracks current execution
5. **Import script** - `npx tsx src/lib/db/import-prd.ts` seeds SQLite from JSON files

### Files created

- `src/lib/db/migrations/005_prd.sql` - PRD tables schema
- `src/lib/db/migrations/006_execution_log.sql` - Execution log and schema cleanup
- `src/lib/db/import-prd.ts` - Import script for JSON → SQLite
- `src/lib/db/prd.ts` - Database operations for PRD data

### Files modified

- `src/lib/data.ts` - Now reads from SQLite via prd.ts
- `src/lib/run-state.ts` - Uses SQLite instead of state.json
- `src/lib/types.ts` - Added target_branch, working_branch; updated RunStatus type
- `src/lib/execution.ts` - Updated to get branch from story
- `src/components/current-work.tsx` - Handle new status values

### Legacy files (still exist but unused)

- `tools/ralph/cli/state.json` - Replaced by run_state table
- `tools/ralph/cli/metrics.json` - Replaced by execution_log table
- `tools/ralph/cli/prd/*.json` - Still used as source for import script

---

## Feature: Signal API for Claude completion

**Time:** 2026-01-30 ~23:00 SAST

### What was done

Added API endpoint for Claude to signal story completion/blocked status. This replaces XML signal parsing from Claude output.

### API Endpoints

```
POST /api/signal
  body: { storyId, action: 'complete' | 'blocked', message?, prUrl? }

GET /api/signal?storyId=X
  returns: { passes, merged, skipped, working_branch, pr_url }
```

### How it works

1. Claude runs implementation as normal
2. When done, Claude calls `curl -X POST http://localhost:3000/api/signal` with completion status
3. Dashboard detects status change via database (no output parsing needed)

### Files created

- `src/app/api/signal/route.ts` - Signal API endpoint

### Files modified

- `src/lib/execution.ts` - Removed XML signal parsing, now checks database state
- `tools/ralph/cli/prompt.md` - Updated to tell Claude about signal API

---

## Improvement: Signal polling and cleanup

**Time:** 2026-01-30 ~23:30 SAST

### What was done

1. **Added signal polling** - Dashboard now waits up to 30s for Claude to call the signal API instead of checking once immediately
2. **Configurable dashboard URL** - Port is now configurable via `dashboardUrl` setting (default: `http://localhost:3000`)
3. **Deleted legacy files** - Removed unused `state.json` and `metrics.json` from `tools/ralph/cli/`

### Files modified

- `src/lib/execution.ts` - Added `waitForSignal()` polling function, inject `dashboardUrl` into prompt
- `tools/ralph/cli/prompt.md` - Uses `{{DASHBOARD_URL}}` placeholder

### Files deleted

- `tools/ralph/cli/state.json` - Replaced by SQLite `run_state` table
- `tools/ralph/cli/metrics.json` - Replaced by SQLite `execution_log` table

---

## Fix: Prompt template placeholders

**Time:** 2026-01-30 ~23:45 SAST

### What was done

Fixed mismatch between prompt.md placeholders and buildPrompt() replacements.

### Placeholders now supported

| Placeholder | Source |
|-------------|--------|
| `{{CURRENT_STORY}}` | story.id |
| `{{VERSION}}` | story.target_version |
| `{{BRANCH}}` | branch param |
| `{{ATTEMPT}}` | attempt param |
| `{{DASHBOARD_URL}}` | settings.dashboardUrl |
| `{{TIMEZONE}}` | settings.timezone |
| `{{STORY_DETAILS}}` | Title, intent, description, acceptance |
| `{{FEEDBACK}}` | Clarification, feedback, external deps report |
| `{{RECENT_ACTIVITY_LOGS}}` | Last 50 lines of today's activity log |

### Files modified

- `src/lib/execution.ts` - Rewrote buildPrompt() with all placeholders, added getRecentActivityLogs()
- `tools/ralph/cli/prompt.md` - Added `{{STORY_DETAILS}}` placeholder

---

## Improvement: Simplify signal API and add settings UI

**Time:** 2026-01-30 ~24:00 SAST

### What was done

1. **Simplified signal API** - Removed unused token tracking params (inputTokens, outputTokens, durationSeconds) since Claude can't provide them
2. **Added dashboardUrl to settings UI** - New "Execution" card with URL input field
3. **Added SAST timezone** - Africa/Johannesburg added to timezone dropdown

### Files modified

- `src/app/api/signal/route.ts` - Removed token params (dashboard handles tracking)
- `src/app/settings/page.tsx` - Added Execution card with dashboardUrl setting, added SAST timezone

---

## Fix: Token tracking from dashboard side

**Time:** 2026-01-31 ~00:15 SAST

### What was done

Actually fixed token tracking instead of just removing it. The dashboard now extracts token usage from Claude's stream-json output and logs it to execution_log.

### How it works

1. `runClaude()` now returns `{ success, duration, inputTokens, outputTokens }`
2. `extractTokenUsage()` parses Claude's JSON output for usage data
3. Execution log is started before Claude runs, completed/failed after
4. All execution outcomes (success, blocked, error, no-signal) log tokens

### Files modified

- `src/lib/execution.ts`:
  - Added `ClaudeResult` interface with token fields
  - Added `extractTokenUsage()` to parse Claude output
  - Updated `runClaude()` to return token counts
  - Updated `runIteration()` to log execution with tokens
  - Renamed import to `prdDb` to avoid naming conflict

---
